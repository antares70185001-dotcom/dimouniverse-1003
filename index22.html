<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë””ëª¨ì™€ í•¨ê»˜ í•˜ëŠ” ìƒìƒ ë†€ì´í„°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet">

  <style>
    :root{
      --main:#5cab6d; --accent:#a5e6b8; --bg:#f8fff9; --text:#173322;
      --shadow:0 12px 40px rgba(0,0,0,.16);
      --logo-unit:60px; /* ë¡œê³  ê¸°ì¤€ê°’(8ë°° ì ìš©) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Poor Story', cursive, sans-serif;background-color:var(--bg);color:var(--text)}
    .screen{display:none}.screen.active{display:block}

    /* ì˜¤ë¡œë¼ ë°°ê²½ */
    body{
      background-image:linear-gradient(270deg,#a5e6b8,#5cab6d,#c6f2d4,#f8fff9);
      background-size:600% 600%; animation:auroraFlow 16s ease infinite;
    }
    @keyframes auroraFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @media (prefers-reduced-motion:reduce){ body{animation:none;background-position:50% 50%} }

    /* ì¸íŠ¸ë¡œì—ì„œë§Œ íŒŒìŠ¤í…” íŒ¨í„´ ë³´ì´ê¸° */
    .pattern{
      position:fixed; inset:0; z-index:-3; pointer-events:none; opacity:.7;
      background:
        radial-gradient(circle at 12% 15%, rgba(165,230,184,.25) 0 140px, transparent 150px),
        radial-gradient(circle at 88% 25%, rgba(169,214,255,.22) 0 120px, transparent 130px),
        radial-gradient(circle at 18% 85%, rgba(255,214,232,.22) 0 140px, transparent 150px),
        radial-gradient(circle at 80% 82%, rgba(255,234,167,.20) 0 130px, transparent 140px);
      animation:dimo-bg-move 28s linear infinite;
    }
    @keyframes dimo-bg-move{
      0%{background-position:0 0,0 0,0 0,0 0}
      100%{background-position:600px 360px,-520px 480px,300px -420px,-300px 300px}
    }
    body:not([data-screen="intro"]) .pattern{ display:none !important; }

    /* ë²„íŠ¼ í†µì¼ */
    :root{ --btn-bg:#a5e6b8; --btn-text:#173322; --btn-shadow:0 4px 12px rgba(0,0,0,.15); --btn-shadow-hover:0 6px 16px rgba(0,0,0,.25); }
    button,.btn{
      font-family:'Poor Story', cursive, sans-serif; font-size:1.3em;
      background:var(--btn-bg); color:var(--btn-text);
      border:none; border-radius:16px; padding:12px 26px;
      box-shadow:var(--btn-shadow);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    button:hover,.btn:hover{ transform:scale(1.06); box-shadow:var(--btn-shadow-hover); }
    button:active,.btn:active{ transform:scale(.98); }
    button:disabled,.btn:disabled{ filter:grayscale(.1) opacity(.7); cursor:not-allowed; }
    .btn-primary,.btn-save{ background:var(--btn-bg)!important; color:var(--btn-text)!important; }

    /* ì¸íŠ¸ë¡œ */
    #intro .intro{ min-height:100svh; display:flex; flex-direction:column; align-items:center; gap:10px; padding:20px; padding-top:clamp(24px,8vh,72px); text-align:center; }
    .intro-top{margin:0;color:#2c7a4c;font-size:clamp(28px,6vw,34px)}
    .intro-top.wave span{display:inline-block;animation:waveChar 1.6s ease-in-out infinite}
    @keyframes waveChar{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .intro-main{
      margin:0;font-size:clamp(40px,12vw,54px);line-height:1.1;
      background:linear-gradient(90deg,#A5E6B8,#A9D6FF,#FFD6E8,#FFEAA7,#A5E6B8);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:300% 100%;
      animation:shine 6s linear infinite; text-shadow:0 4px 10px rgba(0,0,0,.08);
    }
    @keyframes shine{0%{background-position:0%}100%{background-position:100%}}
    video{
      width:min(780px,94vw); max-width:100%; aspect-ratio:16/9; object-fit:cover; background:#f4f4f4;
      border-radius:18px; box-shadow:var(--shadow); max-height:48vh;
    }

    /* ê³µí†µ ë˜í¼ */
    .wrap{max-width:740px;margin:0 auto;padding:16px}
    form{background:#fff;border:3px solid var(--accent);border-radius:20px;padding:22px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;color:#1e3e2d;font-weight:900}
    input,select,textarea{
      width:100%;font-family:'Poor Story', cursive, sans-serif;font-size:18px;border:2px solid #d3f2db;border-radius:12px;padding:14px;background:#fff;
      transition:border .15s, box-shadow .15s
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--main);box-shadow:0 0 0 3px rgba(92,171,109,.18)}
    textarea{min-height:120px;resize:vertical}

    /* ì¹© */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 2px; }
    .chip{ border:none; border-radius:999px; padding:10px 14px; font-size:16px; font-weight:900; background:#eef6ef; color:#17402a; box-shadow:inset 0 0 0 2px #d3f2db; min-height:44px; cursor:pointer; }

    /* ë¯¸ë‹ˆ ìŠ¤í‹°ì»¤ */
    .mini-stickers{ display:flex; gap:8px; margin:0 0 12px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#ffffff,#ffffffcc 70%,transparent); padding-bottom:6px; }
    .mini-sticker{ width:32px;height:32px;border-radius:50%; display:grid; place-items:center; font-size:18px; filter:grayscale(1) opacity(.5); border:2px solid #d3f2db; background:#f6fff8; }
    .mini-sticker.done{ filter:none; opacity:1; border-color:#7bd49a; background:#eafff1; box-shadow:0 3px 10px rgba(0,0,0,.08); }

    /* ê²Œì´ì§€ */
    .gauge-row{display:flex;align-items:center;gap:10px;margin-top:6px}
    .gauge{flex:1;background:#eef6ef;border-radius:12px;height:18px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,.06)}
    .gauge-bar{height:100%;width:0%;background:#ffcc00;transition:width .35s ease, background .35s ease}
    .gcount{min-width:48px;text-align:right;font-weight:900;color:#2d4d38;opacity:.9}
    .gmsg{margin-top:8px;font-size:16px;color:#2d4d38;min-height:1.6em}

    /* ê²°ê³¼ ì¹´ë“œ */
    .card{position:relative;background:#fff;border:3px solid var(--accent);border-radius:20px;padding:10px 10px 56px; max-width:740px;margin:0 auto;box-shadow:0 10px 22px rgba(0,0,0,.12);overflow:hidden}
    .banner{margin:2px 0 6px;text-align:center;color:#2d4d38;font-size:clamp(20px,5vw,24px)}
    .card-body{display:grid;grid-template-columns:1fr;gap:8px;align-items:start}
    .dimo{width:112px;border-radius:16px;display:block;margin:6px auto 10px; transform:scale(1.1); transform-origin:center;}
    .cbox{
      border-radius:12px; border:3px solid transparent; padding:10px 12px; margin:4px 0 6px;
      background:linear-gradient(#edf9f1,#edf9f1) padding-box,
                 conic-gradient(#ff6b6b,#ffd166,#a0e062,#4f92ff,#a48bff,#ff7f7f,#ff6b6b) border-box;
      text-align:center; justify-content:center; font-weight:900; color:#14543a;
      font-size:clamp(18px,4.2vw,20px); line-height:1.28; display:flex; align-items:center; gap:8px;
    }
    .ratings{display:grid;gap:6px}
    .rating{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:4px 8px; background:#f9fffb;border:2px solid #d3f2db;border-radius:10px}
    .rating h3{margin:0; white-space:nowrap; font-size:16px; color:#2d4d38}
    .stars{display:flex;gap:6px;font-size:22px}
    .star{position:relative;color:#d8d8d8}
    .star.full{color:#F5B301}
    .star.half::before{content:"â˜…";position:absolute;left:0;top:0;width:50%;overflow:hidden;color:#F5B301}

    .info{ margin-top:6px; padding:8px 10px; border-radius:12px; border:2px solid #d3f2db; background:#fafffa; text-align:center; font-size:16px; display:flex; flex-direction:column; gap:6px; align-items:center }
    .info strong{ color:var(--main) }

    /* ìŠ¤íƒ¬í”„ */
    #stampArea{position:absolute;inset:0;pointer-events:none}
    .stamp-wrap{position:absolute; transform-origin:top left !important; transform:scale(1.1);}
    .stamp-img{width:100%;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.12));transform-origin:center;opacity:.97}
    .stamp-enter{animation:pop .52s cubic-bezier(.18,1.4,.22,1) forwards, stamp-shiver .22s ease-out .52s 1}
    @keyframes pop{0%{opacity:0;transform:translateY(-14px) scale(1.25) rotate(var(--r,-4deg))}65%{opacity:1;transform:translateY(0) scale(.96) rotate(var(--r,-4deg))}100%{transform:scale(1) rotate(var(--r,-4deg))}}
    @keyframes stamp-shiver{0%{transform:translate(0,0) rotate(var(--r,-4deg))}40%{transform:translate(-0.6px,0.4px) rotate(calc(var(--r,-4deg) + .4deg))}70%{transform:translate(0.4px,-0.6px) rotate(calc(var(--r,-4deg) - .3deg))}100%{transform:translate(0,0) rotate(var(--r,-4deg))}}

    .center{text-align:center;margin-top:10px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:calc(20px + env(safe-area-inset-bottom));
      background:#2c7a4c;color:#fff;padding:12px 16px;border-radius:10px;
      font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.18);opacity:0;visibility:hidden;transition:.25s;z-index:9999
    }
    .toast.show{opacity:1;visibility:visible}

    /* í•˜ë‹¨ ë¡œê³ (ì´ë¯¸ì§€ë¡œ êµì²´, 8ë°°) */
    .footer-logo{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:8px; line-height:1;
    }
    .footer-logo img{ width:calc(var(--logo-unit) * 8); max-width:80vw; height:auto; display:block; }

    /* ì ‘ê·¼ì„±ìš© í† ê¸€/íŒ”ë ˆíŠ¸ëŠ” ìˆ¨ê¹€(ê¸°ëŠ¥ ì œê±°) */
    #contrastFab, .theme-switch{ display:none !important; }
  </style>

  <!-- ì•± ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="dimo.js" defer></script>
</head>
<body>
  <div class="pattern" aria-hidden="true"></div>

  <!-- ì¸íŠ¸ë¡œ -->
  <section id="intro" class="screen active">
    <div class="intro">
      <h2 class="intro-top">ë””ëª¨ì™€ í•¨ê»˜ í•˜ëŠ”</h2>
      <h1 class="intro-main">ìƒìƒ ë†€ì´í„°</h1>

      <video autoplay muted loop playsinline webkit-playsinline poster="dimo_poster.jpg">
        <source src="dimo.mp4" type="video/mp4">
      </video>

      <button id="toForm" class="btn btn-primary">ğŸ‘‹ ë””ëª¨ ë§Œë‚˜ëŸ¬ ê°€ê¸°</button>

      <div class="footer-logo intro-footer">
        <img src="ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ë¡œê³ .png" alt="ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ ë¡œê³ ">
      </div>

      <!-- ì¸ì‚¬ ìŒì„± (ëœë¤ | preload none) -->
      <audio id="intro1" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬1.mp3" preload="none"></audio>
      <audio id="intro2" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬2.mp3" preload="none"></audio>
      <audio id="intro3" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬3.mp3" preload="none"></audio>
      <audio id="intro4" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬4.mp3" preload="none"></audio>
    </div>
  </section>

  <!-- ì„¤ë¬¸ -->
  <section id="formScreen" class="screen">
    <div class="wrap">
      <div id="miniStickers" class="mini-stickers" role="status" aria-live="polite"></div>

      <form id="ideaForm" novalidate autocomplete="on">
        <div class="form-group">
          <label for="age">1. ë””ëª¨ëŠ” ì¹œêµ¬ ë‚˜ì´ê°€ ê¶ê¸ˆí•´! *</label>
          <select id="age" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="8">8ì„¸</option><option value="9">9ì„¸</option><option value="10">10ì„¸</option>
            <option value="11">11ì„¸</option><option value="12">12ì„¸</option><option value="13">13ì„¸</option>
            <option value="14">14ì„¸</option><option value="15">15ì„¸</option><option value="16">16ì„¸</option>
            <option value="17">17ì„¸</option><option value="18">18ì„¸</option><option value="19">19ì„¸</option>
          </select>
        </div>

        <div class="form-group">
          <label for="nickname">2. ë„ˆì˜ ë©‹ì§„ ë³„ëª…ì„ ì •í•´ì¤˜! *</label>
          <input id="nickname" name="nickname" type="text" placeholder="ì˜ˆ: ë°œëª…ì™• ë””ëª¨!"
                 inputmode="text" autocomplete="nickname" autocapitalize="words" spellcheck="false" required>
          <div id="chips-nickname" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="problem">3. 'ì•„~ ì´ê±° ë¶ˆí¸í•˜ë‹¤!' í–ˆë˜ ìˆœê°„ì€? *</label>
          <textarea id="problem" placeholder="ì˜ˆ: ì—°í•„ì´ ìê¾¸ êµ´ëŸ¬ê°€ì„œ ìƒì–´ë²„ë ¤ìš”"
                    inputmode="text" autocapitalize="sentences" spellcheck="true" required></textarea>
          <div id="chips-problem" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="ideaName">4. ê·¸ ë¶ˆí¸ì„ í•´ê²°í•  ë©‹ì§„ ë°œëª…í’ˆ ì´ë¦„ì€? *</label>
          <input id="ideaName" type="text" placeholder="ì˜ˆ: ì•ˆ êµ´ëŸ¬ê°€ëŠ” ì—°í•„"
                 inputmode="text" autocapitalize="words" autocomplete="on" spellcheck="false" required>
          <div id="chips-ideaname" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="ideaDetail">5. ë°œëª…í’ˆì€ ì–´ë–»ê²Œ ì‘ë™í•˜ê³  ë­ê°€ í¸í•´ì ¸? *</label>
          <textarea id="ideaDetail" placeholder="ì˜ˆ: ì—°í•„ì— ì‘ì€ ìì„ì´ ë¶™ì–´ì„œ ì±…ìƒì— ë”± ë¶™ì–´ìš”â€¦"
                    inputmode="text" autocapitalize="sentences" spellcheck="true" required></textarea>

          <div class="gauge-row">
            <div class="gauge" aria-hidden="true">
              <div class="gauge-bar" id="charBar"></div>
            </div>
            <div id="charCount" class="gcount" aria-live="polite">0ì</div>
          </div>
          <div id="charMsg" class="gmsg">ğŸŒ± ì•„ì§ ìƒê°ì˜ ì”¨ì•— ë‹¨ê³„ì˜ˆìš”.</div>

          <div id="chips-ideadetail" class="chips"></div>
        </div>

        <!-- ì´ë©”ì¼ ì•ˆë‚´ ë° ì„ íƒ ì…ë ¥ -->
        <div class="form-group">
          <label>6. (ì„ íƒ) ë³´í˜¸ì ì´ë©”ì¼</label>
          <div style="font-size:14px;color:#2d4d38;opacity:.9;margin:6px 0 10px">
            â€» <b>êµ¿ì¦ˆ ì´ë²¤íŠ¸ ì‘ëª¨ë¥¼ ì›í•  ê²½ìš°ì—ë§Œ</b> ì´ë©”ì¼ì„ ì…ë ¥í•´ìš”. <b>ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ìŠ¤íƒ¬í”„ëŠ” ê·¸ëŒ€ë¡œ ì§„í–‰</b>ë¼ìš”.
          </div>

          <label class="consent-row" style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <input id="emailConsent" type="checkbox" aria-controls="emailBlock" aria-expanded="false" style="width:20px;height:20px;accent-color:var(--main)">
            <span>êµ¿ì¦ˆ ì´ë²¤íŠ¸ ì‘ëª¨ (ì„ íƒ)</span>
          </label>

          <div id="emailBlock" style="display:none;margin-left:2px">
            <input id="parentEmail" type="email" placeholder="ì˜ˆ: parent@example.com"
                   inputmode="email" autocapitalize="off" autocorrect="off" spellcheck="false" style="margin-top:4px">
            <div class="consent-note" style="font-size:14px;color:#2d4d38;opacity:.8;margin-top:6px">
              â€» ì´ë©”ì¼ì€ <b>ê²½í’ˆ(êµ¿ì¦ˆ) ë‹¹ì²¨ ì•ˆë‚´</b> ìš©ë„ë¡œë§Œ ì‚¬ìš©ë˜ë©°, í–‰ì‚¬ ì¢…ë£Œ í›„ ì¦‰ì‹œ íŒŒê¸°ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div class="center"><button type="submit" class="btn btn-primary">ì œì¶œí•˜ê¸°</button></div>
      </form>
    </div>
  </section>

  <!-- ê²°ê³¼ -->
  <section id="resultScreen" class="screen">
    <div class="wrap">
      <div id="card" class="card">
        <h2 class="banner">ğŸ‰ ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì¹´ë“œ ğŸ‰</h2>
        <div class="card-body">
          <img id="dimoImg" class="dimo" alt="ë””ëª¨" src="">
          <div>
            <div id="complimentText" class="cbox">ğŸ’¬ ë””ëª¨ê°€ ì‘ì› ì¤‘!</div>
            <div class="ratings">
              <div class="rating"><h3>ë°˜ì§ì´ëŠ” ìƒìƒë ¥</h3><div id="creativity" class="stars"></div></div>
              <div class="rating"><h3>ì •ë§ ë ê¹Œ? ì ìˆ˜</h3><div id="feasibility" class="stars"></div></div>
              <div class="rating"><h3>ë””ëª¨ì˜ ê¸°ìˆ ë ¥ ë ˆë²¨</h3><div id="technical" class="stars"></div></div>
            </div>
          </div>
        </div>

        <div class="info">
          <span>ğŸ‘¤ <strong>ë°œëª…ì:</strong> <span id="inventorName"></span></span>
          <span>ğŸ’¡ <strong>ë‚´ ë°œëª…í’ˆ:</strong> <span id="ideaDisplay"></span></span>
        </div>

        <div id="stampArea"></div>

        <!-- ë‚ ì§œ/ì‹œê°„ í‘œì‹œ -->
        <div id="cardDate" style="position:absolute;right:10px;bottom:2px;font-size:clamp(12px,1.6vh,14px);opacity:.85;letter-spacing:.2px;"></div>

        <!-- í•˜ë‹¨ ë¡œê³  ì´ë¯¸ì§€ -->
        <div class="footer-logo">
          <img src="ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ë¡œê³ .png" alt="ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ ë¡œê³ ">
        </div>

        <!-- ê²°ê³¼ ì¹­ì°¬ ì˜¤ë””ì˜¤ -->
        <audio id="compliment1" src="ë””ëª¨ì¹­ì°¬01.mp3" preload="none"></audio>
        <audio id="compliment2" src="ë””ëª¨ì¹­ì°¬02.mp3" preload="none"></audio>
        <audio id="compliment3" src="ë””ëª¨ì¹­ì°¬03.mp3" preload="none"></audio>
        <audio id="compliment4" src="ë””ëª¨ì¹­ì°¬04.mp3" preload="none"></audio>
        <audio id="compliment5" src="ë””ëª¨ì¹­ì°¬05.mp3" preload="none"></audio>
        <audio id="compliment6" src="ë””ëª¨ì¹­ì°¬ë©”ì„¸ì§€.mp3" preload="none"></audio>
      </div>

      <div class="center"><button id="saveBtn" class="btn btn-save">ğŸ¨ ì¹´ë“œ ì €ì¥í•˜ê¸°</button></div>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">ğŸ“¥ ì•¨ë²”ì— ì €ì¥ë˜ì—ˆì–´ìš”!</div>
  <div id="fxLayer" aria-hidden="true"></div>
</body>
</html>
// ===== ì„¤ì • =====
const MOBILE = matchMedia('(max-width: 480px), (pointer: coarse)').matches;
const dimoImages = ["dimo01.png","dimo02.png","dimo03.png","dimo04.png"];
const STAR_STEP_MS = 260;

// ===== ìœ í‹¸ =====
async function ensureScript(src){
  if (document.querySelector(`script[src="${src}"]`)) return;
  await new Promise((resolve, reject)=>{
    const s=document.createElement('script'); s.src=src; s.async=true;
    s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
  });
}

let AC=null;
async function resumeAudio(){
  try{
    const C = window.AudioContext || window.webkitAudioContext;
    if(!AC && C) AC = new C();
    if(AC && AC.state === 'suspended') await AC.resume();
  }catch(e){}
}
async function playOne(a){
  if(!a) return false;
  try{
    await resumeAudio();
    if(a.preload === 'none') a.load();
    a.currentTime=0; a.muted=false; a.volume=Math.min(a.volume||1,1);
    await a.play();
    return true;
  }catch(e){ return false; }
}

// ===== ì¸íŠ¸ë¡œ â†’ í¼ (ì˜¤ë””ì˜¤ ë + 2ì´ˆ í›„ ì „í™˜) =====
(function(){
  const btn=document.getElementById('toForm');
  const intro=document.getElementById('intro');
  const form=document.getElementById('formScreen');
  const intros=["intro1","intro2","intro3","intro4"].map(id=>document.getElementById(id)).filter(Boolean);

  function go(){
    intro.classList.remove('active');
    form.classList.add('active');
    updateScreenFlag();
  }

  btn.addEventListener('click', async ()=>{
    btn.disabled = true; btn.style.pointerEvents='none';
    await resumeAudio();

    const audio = intros.length ? intros[Math.floor(Math.random()*intros.length)] : null;

    if(audio){
      const ok = await playOne(audio);
      if(ok){
        audio.onended = ()=> setTimeout(go, 2000); // ëë‚œ ë’¤ 2ì´ˆ í›„ ì „í™˜
      }else{
        // ì¬ìƒì´ ì™„ì „íˆ ë§‰íŒ ê²½ìš°: ì•ˆì „í•˜ê²Œ 2ì´ˆ í›„ ì „í™˜
        setTimeout(go, 2000);
      }
    }else{
      setTimeout(go, 2000);
    }
  });
})();

// ===== í…ìŠ¤íŠ¸ íŒŒë„ =====
(function(){
  const t = document.querySelector('.intro .intro-top');
  if(!t) return;
  const raw = t.textContent; t.textContent = ''; t.classList.add('wave');
  const splitGraphemes = (str)=>{
    if (window.Intl && typeof Intl.Segmenter === 'function') {
      const seg = new Intl.Segmenter('ko', { granularity: 'grapheme' });
      return Array.from(seg.segment(str), s => s.segment);
    }
    return Array.from(str);
  };
  splitGraphemes(raw).forEach((ch,i)=>{
    const s=document.createElement('span');
    s.textContent=(ch===' ') ? '\u00A0' : ch;
    s.style.animationDelay = (i*0.08)+'s';
    t.appendChild(s);
  });
})();

// ===== ì˜ˆì‹œì¹© =====
(function(){
  const MAP = [
    { el:'#chips-nickname',  target:'#nickname',
      items:['ë°œëª…ì™•','ë²ˆì©ì²œì¬','ì•„ì´ë””ì–´ì™•','ë””ëª¨ì¹œêµ¬','ë¬¸ì œí•´ê²°ì‚¬'] },
    { el:'#chips-problem',   target:'#problem',
      items:['ì—°í•„ì´ ìê¾¸ êµ´ëŸ¬ê°€ìš”','ê°€ë°©ì´ ë¬´ê±°ì›Œìš”','ì§€ìš°ê°œê°€ ìì£¼ ì‚¬ë¼ì ¸ìš”','ì±…ìƒì´ ì§€ì €ë¶„í•´ìš”','ì²´ìœ¡ë³µì„ ìì£¼ ìŠì–´ìš”'] },
    { el:'#chips-ideaname',  target:'#ideaName',
      items:['ì•ˆ êµ´ëŸ¬ê°€ëŠ” ì—°í•„','ì´ˆê²½ëŸ‰ ê°€ë°©','ì•ˆ ì‚¬ë¼ì§€ëŠ” ì§€ìš°ê°œ','ì •ë¦¬ì™• ì±…ìƒ','ìŠì§€ë§ˆ ì²´ìœ¡ë³µ í´ë¦½'] },
    { el:'#chips-ideadetail',target:'#ideaDetail',
      items:['ì‘ì€ ìì„ìœ¼ë¡œ ë”± ë¶™ì–´ìš”','ì´ˆê²½ëŸ‰ ì†Œì¬ë¡œ ê°€ë²¼ì›Œìš”','ìŠ¤íŠ¸ë©ìœ¼ë¡œ í•­ìƒ ê³ ì •ë¼ìš”','ì¹¸ì´ ë‚˜ë‰˜ì–´ ì •ë¦¬ ì‰¬ì›Œìš”','ì•± ì•Œë¦¼ìœ¼ë¡œ ìŠì§€ ì•Šì•„ìš”'] },
  ];
  const setOrAppend = (input, text)=>{
    if(!input) return;
    const isEmpty = !input.value || !input.value.trim();
    if(input.tagName==='TEXTAREA'){
      if(isEmpty) input.value = text;
      else input.value = input.value.replace(/\s*$/, '') + (input.value.endsWith('\n')?'':' ') + text;
    }else{
      input.value = isEmpty ? text : (input.value + ' ' + text);
    }
    input.dispatchEvent(new Event('input', {bubbles:true}));
    input.focus();
  };
  MAP.forEach(({el,target,items})=>{
    const box = document.querySelector(el);
    const tgt = document.querySelector(target);
    if(!box || !tgt) return;
    items.forEach(label=>{
      const b=document.createElement('button');
      b.type='button'; b.className='chip'; b.textContent=label;
      b.addEventListener('click', ()=> setOrAppend(tgt, label));
      box.appendChild(b);
    });
  });
})();

// ===== ë¯¸ë‹ˆ ìŠ¤í‹°ì»¤ =====
(function(){
  const holder = document.getElementById('miniStickers');
  if(!holder) return;
  const steps = [
    { id:'age',        icon:'ğŸ‚', label:'ë‚˜ì´' },
    { id:'nickname',   icon:'ğŸ·ï¸', label:'ë³„ëª…' },
    { id:'problem',    icon:'ğŸ§©', label:'ë¬¸ì œ' },
    { id:'ideaName',   icon:'ğŸ’¡', label:'ì´ë¦„' },
    { id:'ideaDetail', icon:'ğŸ› ï¸', label:'ì„¤ëª…' },
  ];
  const nodes = steps.map(s=>{
    const d=document.createElement('div'); d.className='mini-sticker'; d.title=s.label;
    d.innerHTML = `<span aria-hidden="true">${s.icon}</span><span class="label">${s.label}</span>`;
    holder.appendChild(d); return d;
  });

  function validate(){
    const v1 = !!document.getElementById('age').value;
    const v2 = !!document.getElementById('nickname').value.trim();
    const v3 = document.getElementById('problem').value.trim().length >= 5;
    const v4 = !!document.getElementById('ideaName').value.trim();
    const v5 = document.getElementById('ideaDetail').value.trim().length >= 10;
    [v1,v2,v3,v4,v5].forEach((ok,i)=> nodes[i].classList.toggle('done', ok));
  }
  document.getElementById('ideaForm').addEventListener('input', validate);
  document.getElementById('ideaForm').addEventListener('change', validate);
  validate();
})();

// ===== íŒíŠ¸ ì˜¤ë””ì˜¤ =====
(function(){
  function ensureHintAudio(id, src){
    let a = document.getElementById(id);
    if(!a){ a=document.createElement('audio'); a.id = id; a.preload = 'none'; document.body.appendChild(a); }
    a.src = src; return a;
  }
  const aNick = ensureHintAudio('hintNickname','ë³„ëª…ì•ˆë‚´ë©˜íŠ¸.mp3');
  const aIdea = ensureHintAudio('hintIdeaDetail','ì•„ì´ë””ì–´ì„¤ëª…ë©˜íŠ¸.mp3');
  const once={once:true,passive:true};
  const nick = document.getElementById('nickname');
  const idea = document.getElementById('ideaDetail');
  nick?.addEventListener('pointerdown', ()=>playOne(aNick), once);
  nick?.addEventListener('focus',       ()=>playOne(aNick), once);
  idea?.addEventListener('pointerdown', ()=>playOne(aIdea), once);
  idea?.addEventListener('focus',       ()=>playOne(aIdea), once);
})();

// ===== ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ë†’ì´ ê³„ì‚° =====
(function(){
  function fitIntro(){
    const introSec = document.querySelector('#intro .intro');
    const title    = document.querySelector('#intro .intro-top');
    const main     = document.querySelector('#intro .intro-main');
    const video    = document.querySelector('#intro video');
    const cta      = document.getElementById('toForm');
    const footer   = document.querySelector('#intro .footer-logo');
    if(!introSec || !video) return;

    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
    const cs = getComputedStyle(introSec);
    const padY = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
    const h = el => el ? el.getBoundingClientRect().height : 0;
    const others = h(title)+h(main)+h(cta)+h(footer)+24+padY;
    let avail = Math.max(140, vh - others) - 6;
    video.style.maxHeight = avail + 'px';
  }
  addEventListener('load',  fitIntro, {once:true});
  addEventListener('resize', fitIntro);
  if (window.visualViewport) visualViewport.addEventListener('resize', fitIntro);
  requestAnimationFrame(fitIntro);
})();

// ===== ê²Œì´ì§€ =====
(function(){
  const detail=document.getElementById('ideaDetail');
  const bar=document.getElementById('charBar');
  const msg=document.getElementById('charMsg');
  const count=document.getElementById('charCount');

  function update(){
    const len=(detail.value||'').trim().length;
    const pct=Math.min(len/70*100,100);
    bar.style.width=pct+'%';
    if(count) count.textContent = `${len}ì`;

    if(len<30){
      bar.style.background='#ffcc00';
      msg.textContent='ğŸŒ± ì•„ì§ ìƒê°ì˜ ì”¨ì•— ë‹¨ê³„ì˜ˆìš”.';
    } else if(len<40){
      bar.style.background='linear-gradient(90deg,#a8e6c3,#7bd49a)';
      msg.textContent='ğŸ‰ ë””ëª¨ ìŠ¤íƒ¬í”„ íšë“!';
    } else if(len<50){
      bar.style.background='linear-gradient(90deg,#8ac7ff,#4f92ff)';
      msg.textContent='ğŸ’« ë§Œì  ê°€ëŠ¥ì„± ë„ë‹¬!';
    } else if(len<70){
      bar.style.background='linear-gradient(90deg,#a48bff,#6a5acd)';
      msg.textContent='ğŸ’ ë ˆì–´ ìŠ¤íƒ¬í”„ ì¶”ì²¨ê¶Œ íšë“!';
    } else {
      bar.style.background='linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)';
      msg.textContent='ğŸŒˆ ë ˆì–´ ìŠ¤íƒ¬í”„ ë‹¹ì²¨ í™•ë¥  2ë°° ê°•í™”!';
    }
  }
  detail.addEventListener('input',update,{passive:true}); update();
})();

// ===== ì´ë©”ì¼ í† ê¸€ =====
(function(){
  const consent = document.getElementById('emailConsent');
  const block   = document.getElementById('emailBlock');
  const email   = document.getElementById('parentEmail');
  const toggle = ()=>{
    const on = !!consent.checked;
    block.style.display = on ? 'block' : 'none';
    consent.setAttribute('aria-expanded', on ? 'true' : 'false');
    if(!on){ email.value=''; }
  };
  consent.addEventListener('change', toggle, {passive:true}); toggle();
})();

// ===== ëœë¤ ì¹­ì°¬ë¬¸êµ¬ =====
function setComplimentText(){
  const el = document.getElementById('complimentText'); if(!el) return;
  const lines = [
    "ğŸ¤© ì™€ìš°! ì‹¤í–‰ë ¥ë„ ê¸°ëŒ€ë¼",
    "ğŸ’¡ ì•„ì´ë””ì–´ê°€ í†¡! íŠ€ì—ˆì–´",
    "ğŸ‘ ë¬¸ì œì •ì˜ê°€ ê¹”ë”í–ˆì–´",
    "ğŸš€ ìƒìƒë ¥ ë ˆë²¨ì—…! ë‹¤ìŒë„ ê°€ì",
    "ğŸ”§ ì´ê±´ ì§„ì§œ ì¨ë³´ê³  ì‹¶ë‹¤",
    "ğŸ§  ì²œì¬ì˜ ëƒ„ìƒˆê°€â€¦!"
  ];
  el.textContent = 'ğŸ’¬ ' + lines[Math.floor(Math.random()*lines.length)];
}

// ===== ë³„ì  ì• ë‹ˆë©”ì´ì…˜ =====
function animateStarsToScore(id, score){
  return new Promise(resolve=>{
    const el=document.getElementById(id); if(!el) return resolve();
    el.innerHTML = '<span class="star">â˜…</span>'.repeat(5);
    const full=Math.floor(score);
    const hasHalf = (score-full) >= 0.5;
    let idx=0, target=full + (hasHalf?1:0);

    (function step(){
      if(idx>=target){ setTimeout(resolve, 250); return; }
      const s=el.children[idx];
      if(idx<full){ s.classList.add('full'); }
      else if(hasHalf){ s.classList.add('half'); }
      idx++; setTimeout(step, STAR_STEP_MS);
    })();
  });
}

// ===== ì œì¶œ ì²˜ë¦¬ =====
document.getElementById('ideaForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  await resumeAudio();

  const age=document.getElementById('age').value;
  const nickname=document.getElementById('nickname').value.trim();
  const problem=document.getElementById('problem').value.trim();
  const ideaName=document.getElementById('ideaName').value.trim();
  const ideaDetail=document.getElementById('ideaDetail').value.trim();

  const consent = document.getElementById('emailConsent').checked;
  const emailVal= document.getElementById('parentEmail').value.trim();

  if(!age||!nickname||!problem||!ideaName||ideaDetail.length<10){
    alert('ëª¨ë“  í•­ëª©ì„ ì±„ì›Œì¤˜! (ì„¤ëª…ì€ 10ì ì´ìƒ)'); return;
  }
  if(consent){
    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(emailVal);
    if(!emailOk){ alert('ì´ë©”ì¼ í˜•ì‹ì´ ë§ì§€ ì•Šì•„! ì˜ˆ: parent@example.com'); return; }
  }

  // ê²°ê³¼ í™”ë©´ ì „í™˜
  document.getElementById('formScreen').classList.remove('active');
  document.getElementById('resultScreen').classList.add('active');
  updateScreenFlag();

  // ë°ì´í„° ë°”ì¸ë”©
  document.getElementById('inventorName').textContent=nickname;
  document.getElementById('ideaDisplay').textContent=ideaName;
  const dimo=document.getElementById('dimoImg');
  dimo.src=dimoImages[Math.floor(Math.random()*dimoImages.length)];

  // ì ìˆ˜ ê³„ì‚°
  const len=ideaDetail.length;
  let didPerfect=false;
  const scores = (len>=40 && Math.random()<0.04)
    ? (didPerfect=true, {creativity:5,feasibility:5,technical:5})
    : {
        creativity: Math.round((3.5+Math.random()*1.5)*2)/2,
        feasibility: Math.round((3.5+Math.random()*1.5)*2)/2,
        technical: Math.round((3.5+Math.random()*1.5)*2)/2
      };

  // ë³„ì  ì• ë‹ˆ
  await animateStarsToScore('creativity',  scores.creativity);
  await animateStarsToScore('feasibility', scores.feasibility);
  await animateStarsToScore('technical',   scores.technical);

  // ì¹­ì°¬ ë¬¸êµ¬
  setComplimentText();

  // ìŠ¤íƒ¬í”„ ê²°ì •
  let stampSrc=null;
  if(len>=30) stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„01.png';
  if(didPerfect){ stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„ë§Œì 02.png'; }
  else{
    let rareP = (len>=70) ? 0.06 : (len>=50) ? 0.03 : 0;
    if(Math.random()<rareP) stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„ë ˆì–´03.png';
  }

  if(len>=70){ showToastMsg('ğŸ¯ ë ˆì–´ í™•ë¥  2ë°° ê°•í™”!'); }

  setTimeout(async ()=>{
    if(stampSrc){
      const card=document.getElementById('card');
      const stampArea=document.getElementById('stampArea');
      const dimoImg=document.getElementById('dimoImg');

      const cardRect = card.getBoundingClientRect();
      const imgRect  = dimoImg.getBoundingClientRect();

      // ì¹´ë“œ ê¸°ì¤€ ì¢Œí‘œì—ì„œ ë””ëª¨ ì´ë¯¸ì§€ ì˜ì—­
      const bounds = {
        x: imgRect.left - cardRect.left,
        y: imgRect.top  - cardRect.top,
        w: imgRect.width,
        h: imgRect.height
      };

      // ìŠ¤íƒ¬í”„ í¬ê¸° ê³„ì‚° (ê¸°ì¡´ ë¡œì§ ìœ ì§€ + ì•½ê°„ í‚¤ì›€)
      const basePhysical = 132 * 0.8 * 1.1;
      const targetPhysical = Math.min(basePhysical * 1.10, bounds.w * 0.95, bounds.h * 0.95);
      const scaleFactor = 1.1; // CSS scale(1.1)
      const size = Math.round(targetPhysical / scaleFactor);
      const visSize = size * scaleFactor;

      // ğŸ”’ ìš°í•˜ë‹¨ ê³ ì •
      const x = Math.max(bounds.x + bounds.w - visSize, bounds.x);
      const y = Math.max(bounds.y + bounds.h - visSize, bounds.y);
      const rot = (Math.random()*8 - 4).toFixed(1);

      stampArea.innerHTML = `
        <div class="stamp-wrap" style="left:${x}px;top:${y}px;width:${size}px;height:${size}px;">
          <span class="stamp-puff"></span>
          <img src="${stampSrc}" alt="ìŠ¤íƒ¬í”„" class="stamp-img stamp-enter" style="--r:${rot}deg">
          <span class="ink-bleed"></span>
        </div>`;
      if(navigator.vibrate){ try{ navigator.vibrate(30);}catch{} }
    }
    fireConfetti(1800);
    playComplimentWithFallback();
  }, 600);
});

// ===== í† ìŠ¤íŠ¸ =====
function showToastMsg(msg){
  const t=document.getElementById('toast'); if(!t) return;
  if(String(msg).includes('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')) msg = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1600);
}

// ===== ì €ì¥ =====
(function(){
  const btn=document.getElementById('saveBtn'), toast=document.getElementById('toast');
  function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1600); }
  btn.addEventListener('click', async ()=>{
    await ensureScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
    const card=document.getElementById('card');
    const scale=Math.min(MOBILE?1.2:1.5, window.devicePixelRatio||1);
    html2canvas(card,{scale, useCORS:true}).then(canvas=>{
      const link=document.createElement('a');
      link.href=canvas.toDataURL('image/png'); link.download='dimo_card.png';
      if(/iPad|iPhone|iPod/.test(navigator.userAgent)){
        const w=window.open(); if(w&&w.document) w.document.write('<img src="'+link.href+'" style="width:100%">');
      } else link.click();
      showToastMsg('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }).catch(showToast);
  }, {passive:true});
})();

// ===== í™”ë©´ í”Œë˜ê·¸ =====
function updateScreenFlag(){
  const introActive  = document.getElementById('intro')?.classList.contains('active');
  const formActive   = document.getElementById('formScreen')?.classList.contains('active');
  const resultActive = document.getElementById('resultScreen')?.classList.contains('active');
  const screen = introActive ? 'intro' : (formActive ? 'form' : (resultActive ? 'result' : ''));
  document.body.dataset.screen = screen;
}
updateScreenFlag();
new MutationObserver(updateScreenFlag).observe(document.body, {subtree:true, attributes:true, attributeFilter:['class']});

// ===== (íƒ­ ìŠ¤íŒŒí´ + íŒ¨ëŸ´ë™ìŠ¤) =====
(function(){
  const intro = document.getElementById('intro');
  const layer = document.getElementById('fxLayer');
  if(!intro || !layer) return;

  function sparkBurst(x, y){
    const N = 12;
    for(let i=0;i<N;i++){
      const el = document.createElement('span');
      el.className = 'spark';
      el.textContent = (i%3===0) ? 'âœ¦' : (i%4===0 ? 'â˜…' : 'âœ§');
      const ang = Math.random()*Math.PI*2;
      const r   = 52 + Math.random()*68;
      const tx  = (Math.cos(ang)*r).toFixed(1) + 'px';
      const ty  = (Math.sin(ang)*r)*1 + 'px';
      el.style.position='fixed';
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.style.transform = 'translate(-50%,-50%)';
      el.style.animation = 'spark-fly 720ms cubic-bezier(.2,.8,.2,1) forwards';
      el.style.filter = 'drop-shadow(0 2px 6px rgba(0,0,0,.25))';
      el.style.willChange='transform,opacity';
      el.style.zIndex='3500';
      el.style.setProperty('--tx', tx);
      el.style.setProperty('--ty', ty);
      el.style.color = `hsl(${200 + Math.random()*140}, 85%, 60%)`;
      layer.appendChild(el);
      el.addEventListener('animationend', ()=> el.remove(), {once:true});
    }
  }
  intro.addEventListener('pointerdown', (e)=>{ sparkBurst(e.clientX, e.clientY); }, {passive:true});

  if (!matchMedia('(prefers-reduced-motion: reduce)').matches){
    const targets = [
      intro.querySelector('.intro-main'),
      intro.querySelector('video'),
      intro.querySelector('#toForm')
    ].filter(Boolean);
    targets.forEach(el=> el.style.willChange='transform');

    function tilt(e){
      const rect = intro.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top  + rect.height/2;
      const nx = (e.clientX - cx) / rect.width;
      const ny = (e.clientY - cy) / rect.height;
      const MAX_DEG = 6, MAX_MOVE = 6;
      const rx = -ny * MAX_DEG, ry = nx * MAX_DEG;
      const tx = nx * MAX_MOVE,  ty = ny * MAX_MOVE;
      for(const el of targets){
        el.style.transform = `translate3d(${tx}px, ${ty}px, 0) rotateX(${rx}deg) rotateY(${ry}deg)`;
      }
    }
    function reset(){ for(const el of targets){ el.style.transform = 'translate3d(0,0,0) rotateX(0) rotateY(0)'; } }
    intro.addEventListener('pointermove', tilt,   {passive:true});
    intro.addEventListener('pointerleave', reset, {passive:true});
  }
})();

// ===== ì½˜í˜í‹° & ì¹­ì°¬ ì˜¤ë””ì˜¤ =====
async function fireConfetti(duration=1500){
  if(!window.confetti){
    await ensureScript('https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js');
  }
  const end = Date.now() + duration;
  (function frame(){
    confetti({particleCount: 6, startVelocity: 32, spread: 360, origin:{x:Math.random(), y:Math.random()*0.4}});
    if(Date.now() < end) requestAnimationFrame(frame);
  })();
}
function pickRandomComplimentAudio(){
  const ids=["compliment1","compliment2","compliment3","compliment4","compliment5","compliment6"];
  const els=ids.map(id=>document.getElementById(id)).filter(Boolean);
  return els[Math.floor(Math.random()*els.length)];
}
async function playComplimentWithFallback(){
  const a = pickRandomComplimentAudio(); if(!a) return;
  let ok = await playOne(a);
  if(!ok){
    const rs=document.getElementById('resultScreen');
    const handler = async ()=>{ rs.removeEventListener('pointerdown', handler); await playOne(a); };
    rs.addEventListener('pointerdown', handler, {once:true});
  }
}

// ===== ë‚ ì§œ/ì‹œê°„(ì´ˆê¹Œì§€) =====
(function(){
  function pad(n){ return String(n).padStart(2,'0'); }
  function fmt(d){
    return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function ensure(){
    const el=document.getElementById('cardDate'); if(!el) return;
    el.textContent = fmt(new Date());
  }
  // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì „í™˜ë  ë•Œ ì±„ì›€
  const mo = new MutationObserver(()=>{ 
    if(document.body.dataset.screen==='result') ensure();
  });
  mo.observe(document.body,{attributes:true,attributeFilter:['data-screen']});
})();
