<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- build:v8 -->
  <meta charset="UTF-8" />
  <title>ë””ëª¨ì™€ í•¨ê»˜ í•˜ëŠ” ìƒìƒ ë†€ì´í„°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

  <style>
    :root{
      --main:#5cab6d; --accent:#a5e6b8; --bg:#f8fff9; --text:#173322;
      --shadow:0 12px 40px rgba(0,0,0,.16);
      --logo-opacity:.90;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Jua',sans-serif;background:var(--bg);color:var(--text)}
    .screen{display:none}.screen.active{display:block}

    /* ì¸íŠ¸ë¡œì—ì„œë§Œ ì˜¤ë¡œë¼ (reduce-motion ê°€ë“œ) */
    @media (prefers-reduced-motion: no-preference){
      body[data-screen="intro"]{
        background: linear-gradient(270deg,#a5e6b8,#5cab6d,#c6f2d4,#f8fff9);
        background-size: 600% 600%;
        animation: auroraFlow 16s ease infinite;
      }
      @keyframes auroraFlow{
        0%{background-position:0% 50%}
        50%{background-position:100% 50%}
        100%{background-position:0% 50%}
      }
    }

    /* íŒŒìŠ¤í…” ì›€ì§ì„ ë°°ê²½(ì¸íŠ¸ë¡œ ì „ìš©) */
    .pattern{
      position:fixed; inset:0; z-index:-3; pointer-events:none; opacity:.7;
      background:
        radial-gradient(circle at 12% 15%, rgba(165,230,184,.25) 0 140px, transparent 150px),
        radial-gradient(circle at 88% 25%, rgba(169,214,255,.22) 0 120px, transparent 130px),
        radial-gradient(circle at 18% 85%, rgba(255,214,232,.22) 0 140px, transparent 150px),
        radial-gradient(circle at 80% 82%, rgba(255,234,167,.20) 0 130px, transparent 140px);
      animation:dimo-bg-move 28s linear infinite;
    }
    @media (prefers-reduced-motion: reduce){ .pattern{animation:none} }
    @keyframes dimo-bg-move{
      0%{background-position:0 0,0 0,0 0,0 0}
      100%{background-position:600px 360px,-520px 480px,300px -420px,-300px 300px}
    }
    body:not([data-screen="intro"]) .pattern{ display:none !important; }

    /* ë²„íŠ¼ */
    .btn{border:none;border-radius:28px;padding:14px 28px;font-size:18px;font-weight:800;cursor:pointer;white-space:nowrap;min-width:220px;position:relative;z-index:10}
    .btn-primary{background:linear-gradient(90deg,#7bd49a,#4aa06b);color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.12); text-shadow:0 1px 1px rgba(0,0,0,.3)}
    .btn-primary:hover{filter:brightness(1.05);transform:translateY(-1px)}
    .btn:active{animation:jelly .6s}
    @keyframes jelly{0%{transform:scale(1)}30%{transform:scale(.95,1.05)}60%{transform:scale(1.05,.95)}100%{transform:scale(1)}}

    /* ì¸íŠ¸ë¡œ ë ˆì´ì•„ì›ƒ */
    #intro .intro{ min-height:100svh; } @supports (min-height: 100dvh){ #intro .intro{ min-height:100dvh; } }
    .intro{display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;text-align:center;background:linear-gradient(180deg,#f8fff9 0%, #e9fdee 100%);position:relative;padding-top:clamp(24px,8vh,72px)}
    .intro-top{margin:0;color:#2c7a4c;font-size:clamp(28px, 6vw, 34px)}
    .intro-top.wave span{display:inline-block;animation:waveChar 1.6s ease-in-out infinite}
    @media (prefers-reduced-motion: reduce){ .intro-top.wave span{animation:none} }
    @keyframes waveChar{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .intro-main{margin:0;font-size:clamp(40px, 12vw, 54px);line-height:1.1;background:linear-gradient(90deg,#A5E6B8,#A9D6FF,#FFD6E8,#FFEAA7,#A5E6B8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:300% 100%;animation:shine 6s linear infinite;text-shadow:0 4px 10px rgba(0,0,0,.08)}
    @media (prefers-reduced-motion: reduce){ .intro-main{animation:none} }
    @keyframes shine{0%{background-position:0%}100%{background-position:100%}}
    video{width:min(780px,94vw);max-width:100%;aspect-ratio:16/9;object-fit:cover;background:#f4f4f4;border-radius:18px;box-shadow:var(--shadow);max-height:48vh}
    @media (max-width:360px){ video{ margin:8px 0; max-height:44vh } }

    /* ì¸íŠ¸ë¡œ í‘¸í„° ë¡œê³ : **ìŠ¤ì½”í”„ ê³ ì •** */
    #intro .footer-logo{
      font-size:0; line-height:0; color:transparent; text-indent:-9999px; overflow:hidden;
      background:center/contain no-repeat url('ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ë¡œê³ .png?v=20251007-2');
      width:min(90vw, 720px); height:160px;
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 28px);
    }

    /* í¼ */
    .wrap{max-width:740px;margin:0 auto;padding:16px}
    form{background:#fff;border:3px solid var(--accent);border-radius:20px;padding:22px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;color:#1e3e2d;font-weight:900}
    input,select,textarea{width:100%;font-family:'Jua',sans-serif;font-size:18px;border:2px solid #d3f2db;border-radius:12px;padding:14px;background:#fff;transition:border .15s, box-shadow .15s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--main);box-shadow:0 0 0 3px rgba(92,171,109,.18)}
    textarea{min-height:120px;resize:vertical}
    .err-msg{margin-top:6px;font-size:14px;color:#b00020}
    .sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;border:0!important}

    /* ê²Œì´ì§€ */
    .gauge-row{display:flex;align-items:center;gap:10px;margin-top:6px}
    .gauge{flex:1;background:#eef6ef;border-radius:12px;height:18px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,.06)}
    .gauge-bar{height:100%;width:0%;background:#ffcc00;transition:width .35s ease, background .35s ease}
    .gcount{min-width:48px;text-align:right;font-weight:900;color:#2d4d38;opacity:.9}
    .gmsg{margin-top:8px;font-size:16px;color:#2d4d38;min-height:1.6em}

    /* ê²°ê³¼ ì¹´ë“œ */
    .card{position:relative;background:#fff;border:3px solid var(--accent);border-radius:20px;padding:10px 10px 16px;max-width:740px;margin:0 auto;box-shadow:0 10px 22px rgba(0,0,0,.12);overflow:hidden}
    .banner{margin:4px 0 6px;text-align:center;color:#2d4d38;font-size:24px;white-space:nowrap;position:relative}
    .banner::before,.banner::after{content:"ğŸ‰";display:inline-block;margin:0 .3em}
    .card-body{display:grid;grid-template-columns:minmax(98px,120px) 1fr;gap:10px;align-items:center}
    .dimo{width:112px;border-radius:16px;display:none}

    .ratings{display:grid;gap:8px}
    .rating{display:flex;flex-direction:column;gap:6px;background:#f9fffb;border:2px solid #d3f2db;border-radius:10px;padding:6px 10px}
    .rating h3{margin:0;font-size:16px;color:#2d4d38}
    .stars{display:flex;gap:6px;white-space:nowrap;font-size:24px}
    .star{position:relative;color:#d8d8d8}
    .star.full{color:#F5B301}
    .star.half::before{content:"â˜…";position:absolute;left:0;top:0;width:50%;overflow:hidden;color:#F5B301}
    .star.full::after,.star.half::after{display:none}

    .cbox{
      background:#edf9f1; border:2px solid #cdeed8;border-radius:12px;padding:10px 12px;margin:0 0 2px 0;
      font-size:clamp(18px, 4.2vw, 20px);font-weight:900;color:#14543a;display:flex;align-items:center;gap:8px;
      word-break:keep-all; line-height:1.28; text-align:center; justify-content:center;
      background:
        linear-gradient(#edf9f1,#edf9f1) padding-box,
        conic-gradient(#ff6b6b,#ffd166,#a0e062,#4f92ff,#a48bff,#ff7f7f,#ff6b6b) border-box;
      background-clip:padding-box,border-box;
    }

    /* ë°œëª…ì/ë°œëª…í’ˆ */
    .info{margin-top:10px;padding:10px 12px;border-radius:12px;border:2px solid #d3f2db;background:#fafffa;text-align:center;font-size:16px;display:flex;flex-direction:column;gap:6px;align-items:center}
    .info strong{color:var(--main)}

    /* ìŠ¤íƒ¬í”„ */
    #stampArea{position:absolute;inset:0;pointer-events:none}
    .stamp-wrap{position:absolute;transform:none;transform-origin:0 0}
    .stamp-img{width:100%;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.12));transform-origin:center;opacity:.97}
    @keyframes pop{0%{opacity:0;transform:translateY(-14px) scale(1.25) rotate(var(--r,-4deg))}65%{opacity:1;transform:translateY(0) scale(.96) rotate(var(--r,-4deg))}100%{transform:scale(1) rotate(var(--r,-4deg))}}
    @keyframes stamp-shiver{0%{transform:translate(0,0) rotate(var(--r,-4deg))}40%{transform:translate(-0.6px,0.4px) rotate(calc(var(--r,-4deg)+.4deg))}70%{transform:translate(0.4px,-0.6px) rotate(calc(var(--r,-4deg)-.3deg))}100%{transform:translate(0,0) rotate(var(--r,-4deg))}}
    .stamp-puff{position:absolute;inset:0;border-radius:50%;border:3px solid rgba(200,0,0,.35);opacity:0;filter:blur(.3px);animation:puff .6s ease-out .05s forwards}
    @keyframes puff{0%{transform:scale(.7);opacity:.55}100%{transform:scale(1.35);opacity:0}}

    /* ì €ì¥/í† ìŠ¤íŠ¸ */
    .center{text-align:center;margin-top:10px}
    .btn-save{background:linear-gradient(135deg,#bff3c8,#8de0d3);color:#0f3a30;font-weight:900;min-width:260px;padding:12px 20px;text-shadow:0 1px 0 rgba(255,255,255,.6)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(20px + env(safe-area-inset-bottom));background:#2c7a4c;color:#fff;padding:12px 16px;border-radius:10px;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.18);opacity:0;visibility:hidden;transition:.25s;z-index:9999}
    .toast.show{opacity:1;visibility:visible}
    #fxLayer{position:fixed;inset:0;pointer-events:none;z-index:3000}

    /* ê³ ëŒ€ë¹„ */
    body[data-contrast="high"]{--bg:#ffffff; --text:#0b0f14; --main:#0d6e3e; --accent:#84d19d;}
    body[data-contrast="high"] .btn-primary{background:#0d6e3e !important; text-shadow:none;}

    /* ê³ ëŒ€ë¹„ FAB */
    .fab-contrast{position:fixed; left:12px; bottom:calc(16px + env(safe-area-inset-bottom)); height:44px; min-width:44px; padding:0 14px; border-radius:999px; border:2px solid rgba(0,0,0,.08); background:#fff; color:#0b0f14; font-weight:900; z-index:2100; display:flex; align-items:center; gap:8px; box-shadow:0 6px 18px rgba(0,0,0,.14)}
    .fab-contrast .dot{ width:16px; height:16px; border-radius:50%; background:linear-gradient(135deg,#000,#fff); box-shadow:inset 0 0 0 2px rgba(0,0,0,.1) }
    #contrastFab span:last-child{ display:none }            /* ë¼ë²¨ ìˆ¨ê¹€ */
    body[data-screen="intro"]  #contrastFab{ display:none } /* ì¸íŠ¸ë¡œ/ê²°ê³¼ ìˆ¨ê¹€ */
    body[data-screen="result"] #contrastFab{ display:none }

    /* ì¹©/ë¯¸ë‹ˆìŠ¤í‹°ì»¤ */
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 2px }
    .chip{ border:none; border-radius:999px; padding:10px 14px; font-size:16px; font-weight:900; background:#eef6ef; color:#17402a; box-shadow:inset 0 0 0 2px #d3f2db; min-height:44px; cursor:pointer }
    .chip:active{ transform:scale(.98) }
    .mini-stickers{ display:flex; align-items:center; gap:8px; margin:0 0 12px; position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#ffffff, #ffffffcc 70%, transparent); padding-bottom:6px }
    .mini-sticker{ width:32px; height:32px; border-radius:50%; display:grid; place-items:center; font-size:18px; filter:grayscale(1) opacity(.5); border:2px solid #d3f2db; background:#f6fff8 }
    .mini-sticker.done{ filter:none; opacity:1; border-color:#7bd49a; background:#eafff1; box-shadow:0 3px 10px rgba(0,0,0,.08) }
    .mini-sticker .label{ position:absolute; left:-9999px }

    /* ê²°ê³¼ í™”ë©´ ë§ˆë¬´ë¦¬ í„ìŠ¤(1íšŒ) */
    @media (prefers-reduced-motion: no-preference){
      .finish-pulse{ animation:cardPulse .9s ease-out 1 }
      @keyframes cardPulse{0%{ box-shadow:0 10px 22px rgba(0,0,0,.12); transform:scale(1) }50%{ box-shadow:0 16px 32px rgba(0,0,0,.14); transform:scale(1.01) }100%{ box-shadow:0 10px 22px rgba(0,0,0,.12); transform:scale(1) }}
    }

    /* ê²°ê³¼ ë¡œê³ (í•˜ë‹¨ ì¤‘ì•™, ê¸€ë¼ìŠ¤) â€” **ë¬¸ì„œ ë§ˆì§€ë§‰ì— ë°°ì¹˜í•´ ìš°ì„ ìˆœìœ„ ìŠ¹ë¦¬** */
    #resultScreen .card .footer-logo{
      position:absolute; left:50%; transform:translateX(-50%); bottom:10px; line-height:1;
      width:clamp(140px,42%,260px); height:36px;
      background:center/contain no-repeat url('ë””ëª¨ìœ ë‹ˆë²„ìŠ¤ë¡œê³ .png?v=20251007-2');
      opacity:var(--logo-opacity); filter:drop-shadow(0 2px 6px rgba(0,0,0,.08));
      transition:opacity .18s ease; font-size:0; text-indent:-9999px; color:transparent; overflow:hidden;
    }
    #resultScreen .card .footer-logo:hover{ opacity:1 }
    #resultScreen .card{ padding-bottom:88px } /* ë¡œê³  ê²¹ì¹¨ ë°©ì§€ */

    /* ê²°ê³¼ ë ˆì´ì•„ì›ƒ ë³´ì • */
    #resultScreen .card-body{ gap:8px; grid-template-columns:1fr; align-items:start }
    #resultScreen .dimo{ display:block; margin:6px auto 10px; transform:scale(1.1); transform-origin:center }
    #resultScreen .ratings{ gap:6px }
    #resultScreen .rating{ padding:4px 8px }
    #resultScreen .stars{ font-size:22px }
    #resultScreen .info{ margin-top:6px; padding:8px 10px }
  </style>
</head>
<body>
  <button id="contrastFab" class="fab-contrast" type="button" aria-pressed="false" aria-label="ê³ ëŒ€ë¹„ ëª¨ë“œ í† ê¸€">
    <span class="dot" aria-hidden="true"></span><span>ê³ ëŒ€ë¹„</span>
  </button>

  <div class="pattern" aria-hidden="true"></div>

  <!-- ì¸íŠ¸ë¡œ -->
  <section id="intro" class="screen active">
    <div class="intro">
      <h2 class="intro-top">ë””ëª¨ì™€ í•¨ê»˜ í•˜ëŠ”</h2>
      <h1 class="intro-main">ìƒìƒ ë†€ì´í„°</h1>

      <video autoplay muted loop playsinline webkit-playsinline poster="dimo_poster.jpg?v=20251007-2">
        <source src="dimo.mp4?v=20251007-2" type="video/mp4">
      </video>

      <button id="toForm" class="btn btn-primary">ğŸ‘‹ ë””ëª¨ ë§Œë‚˜ëŸ¬ ê°€ê¸°</button>

      <div class="footer-logo intro-footer">DIMO UNIVERSE</div>

      <!-- ì¸ì‚¬ ìŒì„± -->
      <audio id="intro1" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬1.mp3?v=20251007-2" preload="none"></audio>
      <audio id="intro2" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬2.mp3?v=20251007-2" preload="none"></audio>
      <audio id="intro3" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬3.mp3?v=20251007-2" preload="none"></audio>
      <audio id="intro4" src="ë””ëª¨ì¸íŠ¸ë¡œì¸ì‚¬4.mp3?v=20251007-2" preload="none"></audio>
    </div>
  </section>

  <!-- ì„¤ë¬¸ -->
  <section id="formScreen" class="screen">
    <div class="wrap">
      <div id="miniStickers" class="mini-stickers" role="status" aria-live="polite"></div>

      <form id="ideaForm" novalidate autocomplete="on">
        <div class="form-group">
          <label for="age">1. ë””ëª¨ëŠ” ì¹œêµ¬ ë‚˜ì´ê°€ ê¶ê¸ˆí•´! *</label>
          <select id="age" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="8">8ì„¸</option><option value="9">9ì„¸</option><option value="10">10ì„¸</option>
            <option value="11">11ì„¸</option><option value="12">12ì„¸</option><option value="13">13ì„¸</option>
            <option value="14">14ì„¸</option><option value="15">15ì„¸</option><option value="16">16ì„¸</option>
            <option value="17">17ì„¸</option><option value="18">18ì„¸</option><option value="19">19ì„¸</option>
          </select>
        </div>

        <div class="form-group">
          <label for="nickname">2. ë„ˆì˜ ë©‹ì§„ ë³„ëª…ì„ ì •í•´ì¤˜! *</label>
          <input id="nickname" name="nickname" type="text" placeholder="ì˜ˆ: ë°œëª…ì™• ë””ëª¨!"
                 inputmode="text" autocomplete="nickname" autocapitalize="words" spellcheck="false" required aria-describedby="nickHelp">
          <div id="nickHelp" class="sr-only">ë³„ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
          <div id="chips-nickname" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="problem">3. 'ì•„~ ì´ê±° ë¶ˆí¸í•˜ë‹¤!' í–ˆë˜ ìˆœê°„ì€? *</label>
          <textarea id="problem" placeholder="ì˜ˆ: ì—°í•„ì´ ìê¾¸ êµ´ëŸ¬ê°€ì„œ ìƒì–´ë²„ë ¤ìš”"
                    inputmode="text" autocapitalize="sentences" spellcheck="true" required aria-describedby="problemHelp"></textarea>
          <div id="problemHelp" class="sr-only">ë¶ˆí¸í–ˆë˜ ìˆœê°„ì„ ì ì–´ì£¼ì„¸ìš”. ìµœì†Œ 5ì.</div>
          <div id="chips-problem" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="ideaName">4. ê·¸ ë¶ˆí¸ì„ í•´ê²°í•  ë©‹ì§„ ë°œëª…í’ˆ ì´ë¦„ì€? *</label>
          <input id="ideaName" type="text" placeholder="ì˜ˆ: ì•ˆ êµ´ëŸ¬ê°€ëŠ” ì—°í•„"
                 inputmode="text" autocapitalize="words" autocomplete="on" spellcheck="false" required aria-describedby="nameHelp">
          <div id="nameHelp" class="sr-only">ë°œëª…í’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
          <div id="chips-ideaname" class="chips"></div>
        </div>

        <div class="form-group">
          <label for="ideaDetail">5. ë°œëª…í’ˆì€ ì–´ë–»ê²Œ ì‘ë™í•˜ê³  ë­ê°€ í¸í•´ì ¸? *</label>
          <textarea id="ideaDetail" placeholder="ì˜ˆ: ì—°í•„ì— ì‘ì€ ìì„ì´ ë¶™ì–´ì„œ ì±…ìƒì— ë”± ë¶™ì–´ìš”â€¦"
                    inputmode="text" autocapitalize="sentences" spellcheck="true" required aria-describedby="detailHelp"></textarea>
          <div id="detailHelp" class="sr-only">ìµœì†Œ 10ì ì´ìƒ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”.</div>

          <div class="gauge-row">
            <div class="gauge" aria-hidden="true"><div class="gauge-bar" id="charBar"></div></div>
            <div id="charCount" class="gcount" aria-live="polite">0ì</div>
          </div>
          <div id="charMsg" class="gmsg">ğŸŒ± ì•„ì§ ìƒê°ì˜ ì”¨ì•— ë‹¨ê³„ì˜ˆìš”.</div>

          <div id="chips-ideadetail" class="chips"></div>
        </div>

        <!-- ì´ë©”ì¼ (ì„ íƒ) -->
        <div class="form-group">
          <label>6. (ì„ íƒ) ë³´í˜¸ì ì´ë©”ì¼</label>
          <div style="font-size:14px;color:#2d4d38;opacity:.9;margin:6px 0 10px">â€» <b>êµ¿ì¦ˆ ì´ë²¤íŠ¸ ì‘ëª¨ë¥¼ ì›í•  ê²½ìš°ì—ë§Œ</b> ì´ë©”ì¼ì„ ì…ë ¥í•´ìš”. <b>ì…ë ¥í•˜ì§€ ì•Šì•„ë„ ìŠ¤íƒ¬í”„ëŠ” ê·¸ëŒ€ë¡œ ì§„í–‰</b>ë¼ìš”.</div>
          <label class="consent-row" style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            <input id="emailConsent" type="checkbox" aria-controls="emailBlock" aria-expanded="false" style="width:20px;height:20px;accent-color:var(--main)">
            <span>êµ¿ì¦ˆ ì´ë²¤íŠ¸ ì‘ëª¨ (ì„ íƒ)</span>
          </label>
          <div id="emailBlock" style="display:none;margin-left:2px">
            <input id="parentEmail" type="email" placeholder="ì˜ˆ: parent@example.com" inputmode="email" autocapitalize="off" autocorrect="off" spellcheck="false" style="margin-top:4px">
            <div class="consent-note" style="font-size:14px;color:#2d4d38;opacity:.8;margin-top:6px">â€» ì´ë©”ì¼ì€ <b>ê²½í’ˆ(êµ¿ì¦ˆ) ë‹¹ì²¨ ì•ˆë‚´</b> ìš©ë„ë¡œë§Œ ì‚¬ìš©ë˜ë©°, í–‰ì‚¬ ì¢…ë£Œ í›„ ì¦‰ì‹œ íŒŒê¸°ë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="center"><button type="submit" class="btn btn-primary">âœ¨ ë””ëª¨ì—ê²Œ ë³´ë‚´ê¸°</button></div>
      </form>
    </div>
  </section>

  <!-- ê²°ê³¼ -->
  <section id="resultScreen" class="screen">
    <div class="wrap">
      <div id="card" class="card">
        <h2 class="banner">ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì¹´ë“œ</h2>
        <div class="card-body">
          <img id="dimoImg" class="dimo" alt="ë””ëª¨" src="" crossorigin="anonymous">
          <div>
            <div id="complimentText" class="cbox">ğŸ’¬ ë””ëª¨ê°€ ì‘ì› ì¤‘!</div>
            <div class="ratings">
              <div class="rating"><h3>ë°˜ì§ì´ëŠ” ìƒìƒë ¥</h3><div id="creativity" class="stars" role="img" aria-label="ìƒìƒë ¥ ì ìˆ˜"></div></div>
              <div class="rating"><h3>ì •ë§ ë ê¹Œ? ì ìˆ˜</h3><div id="feasibility" class="stars" role="img" aria-label="ì‹¤í˜„ ê°€ëŠ¥ì„± ì ìˆ˜"></div></div>
              <div class="rating"><h3>ë””ëª¨ì˜ ê¸°ìˆ ë ¥ ë ˆë²¨</h3><div id="technical" class="stars" role="img" aria-label="ê¸°ìˆ ë ¥ ì ìˆ˜"></div></div>
            </div>
          </div>
        </div>

        <div class="info">
          <span>ğŸ‘¤ <strong>ë°œëª…ì:</strong> <span id="inventorName"></span></span>
          <span>ğŸ’¡ <strong>ë‚´ ë°œëª…í’ˆ:</strong> <span id="ideaDisplay"></span></span>
        </div>

        <div id="stampArea"></div>
        <div class="footer-logo">DIMO UNIVERSE</div>

        <!-- ê²°ê³¼ ì¹­ì°¬ ì˜¤ë””ì˜¤ -->
        <audio id="compliment1" src="ë””ëª¨ì¹­ì°¬01.mp3?v=20251007-2" preload="none"></audio>
        <audio id="compliment2" src="ë””ëª¨ì¹­ì°¬02.mp3?v=20251007-2" preload="none"></audio>
        <audio id="compliment3" src="ë””ëª¨ì¹­ì°¬03.mp3?v=20251007-2" preload="none"></audio>
        <audio id="compliment4" src="ë””ëª¨ì¹­ì°¬04.mp3?v=20251007-2" preload="none"></audio>
        <audio id="compliment5" src="ë””ëª¨ì¹­ì°¬05.mp3?v=20251007-2" preload="none"></audio>
        <audio id="compliment6" src="ë””ëª¨ì¹­ì°¬ë©”ì„¸ì§€.mp3?v=20251007-2" preload="none"></audio>
      </div>

      <div class="center"><button id="saveBtn" class="btn btn-save">ğŸ¨ ì¹´ë“œ ì•¨ë²”ì— ì €ì¥</button></div>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">ğŸ“¥ ì•¨ë²”ì— ì €ì¥ë˜ì—ˆì–´ìš”!</div>
  <div id="fxLayer" aria-hidden="true"></div>

  <script>
    /* ===== v8: ìºì‹œ ë¬´ë ¥í™” + ìŠ¤íƒ¬í”„ íƒ€ì´ë° ë³´ê°• + ìŠ¤íƒ€ì¼ ìŠ¤ì½”í”„ ê³ ì • ===== */
    const MOBILE = matchMedia('(max-width: 480px), (pointer: coarse)').matches;
    const REDUCED = matchMedia('(prefers-reduced-motion: reduce)').matches;
    const VER = 'v=20251007-2';
    const addVer = (u)=> u + (u.includes('?') ? '&' : '?') + VER;

    const dimoImages = ["dimo01.png","dimo02.png","dimo03.png","dimo04.png"].map(addVer);
    const STAR_STEP_MS = 260;

    async function ensureScript(src){
      if (document.querySelector(`script[src="${src}"]`)) return;
      await new Promise((resolve, reject)=>{
        const s=document.createElement('script'); s.src=src; s.async=true;
        s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }

    /* ì˜¤ë””ì˜¤ */
    let AC=null;
    async function resumeAudio(){
      try{
        const C = window.AudioContext || window.webkitAudioContext;
        if(!AC && C) AC = new C();
        if(AC && AC.state === 'suspended') await AC.resume();
      }catch(e){}
    }
    async function playOne(a){
      if(!a) return false;
      try{
        await resumeAudio();
        if(a.preload === 'none') a.load();
        a.currentTime=0; a.muted=false; a.volume=Math.min(a.volume||1,1);
        await a.play();
        return true;
      }catch(e){ return false; }
    }

    /* ì½˜í˜í‹° */
    async function fireConfetti(duration=1500){
      if(REDUCED) return;
      if(!window.confetti){
        await ensureScript('https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js');
      }
      const end = Date.now() + duration;
      (function frame(){
        confetti({particleCount: 6, startVelocity: 32, spread: 360, origin:{x:Math.random(), y:Math.random()*0.4}});
        if(Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    function pickRandomComplimentAudio(){
      const ids=["compliment1","compliment2","compliment3","compliment4","compliment5","compliment6"];
      const els=ids.map(id=>document.getElementById(id)).filter(Boolean);
      return els[Math.floor(Math.random()*els.length)];
    }
    async function playComplimentWithFallback(){
      const a = pickRandomComplimentAudio(); if(!a) return;
      let ok = await playOne(a);
      if(!ok){
        const rs=document.getElementById('resultScreen');
        const handler = async ()=>{ rs.removeEventListener('pointerdown', handler); await playOne(a); };
        rs.addEventListener('pointerdown', handler, {once:true});
      }
    }

    /* ì¸íŠ¸ë¡œ â†’ í¼ ì „í™˜ */
    (function(){
      const btn=document.getElementById('toForm');
      const intro=document.getElementById('intro');
      const form=document.getElementById('formScreen');
      const intros=["intro1","intro2","intro3","intro4"].map(id=>document.getElementById(id)).filter(Boolean);
      let selected=null, clicked=false;

      btn.addEventListener('pointerdown', async ()=>{
        if(!selected && intros.length){ selected = intros[Math.floor(Math.random()*intros.length)]; await playOne(selected); }
      }, {once:true});

      btn.addEventListener('click', async ()=>{
        if(clicked) return; clicked = true;
        btn.disabled = true; btn.style.pointerEvents='none';
        if(!selected && intros.length){ selected = intros[Math.floor(Math.random()*intros.length)]; await playOne(selected); }

        const go=()=>{ intro.classList.remove('active'); form.classList.add('active'); updateScreenFlag(); };

        if(selected && !selected.paused){ selected.addEventListener('ended', ()=> setTimeout(go, 2000), {once:true}); }
        else{ setTimeout(go, 2000); }
      });
    })();

    /* í•œ ë²ˆë§Œ ì‹¤í–‰ ê°€ë“œ */
    (function(){
      const btn = document.getElementById('toForm');
      if(!btn) return;
      let used = false;
      btn.addEventListener('click', function(e){ if(used){ e.stopImmediatePropagation(); e.preventDefault(); return; } used = true; }, true);
    })();

    /* íƒ€ì´í‹€ ë¬¼ê²° */
    (function(){
      const t = document.querySelector('.intro .intro-top'); if(!t) return;
      const raw = t.textContent; t.textContent = ''; t.classList.add('wave');
      const splitGraphemes = (str)=> (window.Intl&&Intl.Segmenter) ? Array.from(new Intl.Segmenter('ko',{granularity:'grapheme'}).segment(str), s=>s.segment) : Array.from(str);
      splitGraphemes(raw).forEach((ch,i)=>{
        const s=document.createElement('span');
        s.textContent=(ch===' ') ? '\u00A0' : ch;
        s.style.animationDelay = (i*0.08)+'s';
        if(REDUCED) s.style.animation='none';
        t.appendChild(s);
      });
    })();

    /* ì˜ˆì‹œì¹© */
    (function(){
      const MAP = [
        { el:'#chips-nickname',  target:'#nickname',  items:['ë°œëª…ì™•','ë²ˆì©ì²œì¬','ì•„ì´ë””ì–´ì™•','ë””ëª¨ì¹œêµ¬','ë¬¸ì œí•´ê²°ì‚¬'] },
        { el:'#chips-problem',   target:'#problem',   items:['ì—°í•„ì´ ìê¾¸ êµ´ëŸ¬ê°€ìš”','ê°€ë°©ì´ ë¬´ê±°ì›Œìš”','ì§€ìš°ê°œê°€ ìì£¼ ì‚¬ë¼ì ¸ìš”','ì±…ìƒì´ ì§€ì €ë¶„í•´ìš”','ì²´ìœ¡ë³µì„ ìì£¼ ìŠì–´ìš”'] },
        { el:'#chips-ideaname',  target:'#ideaName',  items:['ì•ˆ êµ´ëŸ¬ê°€ëŠ” ì—°í•„','ì´ˆê²½ëŸ‰ ê°€ë°©','ì•ˆ ì‚¬ë¼ì§€ëŠ” ì§€ìš°ê°œ','ì •ë¦¬ì™• ì±…ìƒ','ìŠì§€ë§ˆ ì²´ìœ¡ë³µ í´ë¦½'] },
        { el:'#chips-ideadetail',target:'#ideaDetail',items:['ì‘ì€ ìì„ìœ¼ë¡œ ë”± ë¶™ì–´ìš”','ì´ˆê²½ëŸ‰ ì†Œì¬ë¡œ ê°€ë²¼ì›Œìš”','ìŠ¤íŠ¸ë©ìœ¼ë¡œ í•­ìƒ ê³ ì •ë¼ìš”','ì¹¸ì´ ë‚˜ë‰˜ì–´ ì •ë¦¬ ì‰¬ì›Œìš”','ì•± ì•Œë¦¼ìœ¼ë¡œ ìŠì§€ ì•Šì•„ìš”'] },
      ];
      const setOrAppend = (input, text)=>{
        if(!input) return;
        const isEmpty = !input.value || !input.value.trim();
        if(input.tagName==='TEXTAREA'){ input.value = isEmpty ? text : input.value.replace(/\s*$/, '') + (input.value.endsWith('\n')?'':' ') + text; }
        else{ input.value = isEmpty ? text : (input.value + ' ' + text); }
        input.dispatchEvent(new Event('input', {bubbles:true})); input.focus();
      };
      MAP.forEach(({el,target,items})=>{
        const box = document.querySelector(el); const tgt = document.querySelector(target);
        if(!box || !tgt) return;
        items.forEach(label=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=label; b.addEventListener('click', ()=> setOrAppend(tgt, label)); box.appendChild(b); });
      });
    })();

    /* ë¯¸ë‹ˆ ìŠ¤í‹°ì»¤ */
    (function(){
      const holder = document.getElementById('miniStickers'); if(!holder) return;
      const steps = [{id:'age',icon:'ğŸ‚',label:'ë‚˜ì´'},{id:'nickname',icon:'ğŸ·ï¸',label:'ë³„ëª…'},{id:'problem',icon:'ğŸ§©',label:'ë¬¸ì œ'},{id:'ideaName',icon:'ğŸ’¡',label:'ì´ë¦„'},{id:'ideaDetail',icon:'ğŸ› ï¸',label:'ì„¤ëª…'}];
      const nodes = steps.map(s=>{const d=document.createElement('div');d.className='mini-sticker';d.title=s.label;d.innerHTML=`<span aria-hidden="true">${s.icon}</span><span class="label">${s.label}</span>`;holder.appendChild(d);return d;});
      function validate(){
        const v1=!!document.getElementById('age').value;
        const v2=!!document.getElementById('nickname').value.trim();
        const v3=document.getElementById('problem').value.trim().length>=5;
        const v4=!!document.getElementById('ideaName').value.trim();
        const v5=document.getElementById('ideaDetail').value.trim().length>=10;
        [v1,v2,v3,v4,v5].forEach((ok,i)=> nodes[i].classList.toggle('done', ok));
      }
      document.getElementById('ideaForm').addEventListener('input', validate);
      document.getElementById('ideaForm').addEventListener('change', validate);
      validate();
    })();

    /* ê³ ëŒ€ë¹„ í† ê¸€ */
    (function(){
      const btn = document.getElementById('contrastFab'); const KEY = 'dimo_contrast_high';
      const apply = (on)=>{ document.body.dataset.contrast = on ? 'high' : ''; btn.setAttribute('aria-pressed', on ? 'true' : 'false'); };
      apply(localStorage.getItem(KEY)==='1');
      btn.addEventListener('click', ()=>{ const next = !(localStorage.getItem(KEY)==='1'); localStorage.setItem(KEY, next ? '1':'0'); apply(next); });
    })();

    /* íŒíŠ¸ ì˜¤ë””ì˜¤ */
    (function(){
      function ensureHintAudio(id, src){ let a=document.getElementById(id); if(!a){ a=document.createElement('audio'); a.id=id; a.preload='none'; document.body.appendChild(a); } a.src=addVer(src); return a; }
      const aNick = ensureHintAudio('hintNickname',   'ë³„ëª…ì•ˆë‚´ë©˜íŠ¸.mp3');
      const aIdea = ensureHintAudio('hintIdeaDetail', 'ì•„ì´ë””ì–´ì„¤ëª…ë©˜íŠ¸.mp3');
      const once={once:true,passive:true};
      const nick = document.getElementById('nickname'); const idea = document.getElementById('ideaDetail');
      nick?.addEventListener('pointerdown', ()=>playOne(aNick), once);
      nick?.addEventListener('focus',       ()=>playOne(aNick), once);
      idea?.addEventListener('pointerdown', ()=>playOne(aIdea), once);
      idea?.addEventListener('focus',       ()=>playOne(aIdea), once);
    })();

    /* ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ë†’ì´ */
    (function(){
      function fitIntro(){
        const introSec = document.querySelector('#intro .intro');
        const title = document.querySelector('#intro .intro-top');
        const main  = document.querySelector('#intro .intro-main');
        const video = document.querySelector('#intro video');
        const cta   = document.getElementById('toForm');
        const footer= document.querySelector('#intro .footer-logo');
        if(!introSec || !video) return;
        const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
        const cs = getComputedStyle(introSec);
        const padY = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
        const h = el => el ? el.getBoundingClientRect().height : 0;
        const others = h(title)+h(main)+h(cta)+h(footer)+24+padY;
        let avail = Math.max(140, vh - others) - 6;
        video.style.maxHeight = avail + 'px';
      }
      addEventListener('load',  fitIntro, {once:true});
      addEventListener('resize', fitIntro);
      if (window.visualViewport) visualViewport.addEventListener('resize', fitIntro);
      requestAnimationFrame(fitIntro);
    })();

    /* ê²Œì´ì§€ */
    (function(){
      const detail=document.getElementById('ideaDetail');
      const bar=document.getElementById('charBar');
      const msg=document.getElementById('charMsg');
      const count=document.getElementById('charCount');
      function update(){
        const len=(detail.value||'').trim().length;
        const pct=Math.min(len/70*100,100);
        bar.style.width=pct+'%';
        if(count) count.textContent = `${len}ì`;
        if(len<30){ bar.style.background='#ffcc00'; msg.textContent='ğŸŒ± ì•„ì§ ìƒê°ì˜ ì”¨ì•— ë‹¨ê³„ì˜ˆìš”.'; }
        else if(len<40){ bar.style.background='linear-gradient(90deg,#a8e6c3,#7bd49a)'; msg.textContent='ğŸ‰ ë””ëª¨ ìŠ¤íƒ¬í”„ íšë“!'; }
        else if(len<50){ bar.style.background='linear-gradient(90deg,#8ac7ff,#4f92ff)'; msg.textContent='ğŸ’« ë§Œì  ê°€ëŠ¥ì„± ë„ë‹¬!'; }
        else if(len<70){ bar.style.background='linear-gradient(90deg,#a48bff,#6a5acd)'; msg.textContent='ğŸ’ ë ˆì–´ ìŠ¤íƒ¬í”„ ì¶”ì²¨ê¶Œ íšë“!'; }
        else{ bar.style.background='linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)'; msg.textContent='ğŸŒˆ ë ˆì–´ ìŠ¤íƒ¬í”„ ë‹¹ì²¨ í™•ë¥  2ë°° ê°•í™”!'; }
      }
      detail.addEventListener('input',update,{passive:true}); update();
    })();

    /* ì´ë©”ì¼ í† ê¸€ */
    (function(){
      const consent = document.getElementById('emailConsent');
      const block   = document.getElementById('emailBlock');
      const email   = document.getElementById('parentEmail');
      const toggle = ()=>{ const on = !!consent.checked; block.style.display = on ? 'block' : 'none'; consent.setAttribute('aria-expanded', on ? 'true' : 'false'); if(!on){ email.value=''; } };
      consent.addEventListener('change', toggle, {passive:true}); toggle();
    })();

    /* ë³„ì  ì• ë‹ˆ + ARIA */
    function animateStarsToScore(id, score, label){
      return new Promise(resolve=>{
        const el=document.getElementById(id); if(!el) return resolve();
        el.innerHTML = '<span class="star" aria-hidden="true">â˜…</span>'.repeat(5);
        const full=Math.floor(score); const hasHalf = (score-full) >= 0.5;
        let idx=0, target=full + (hasHalf?1:0);
        (function step(){
          if(idx>=target){ el.setAttribute('aria-label', `${label} ${score}ì  / 5ì `); setTimeout(resolve, 250); return; }
          const s=el.children[idx]; if(idx<full){ s.classList.add('full'); } else if(hasHalf){ s.classList.add('half'); }
          idx++; setTimeout(step, STAR_STEP_MS);
        })();
      });
    }

    /* í¼ ì œì¶œ */
    function clearErrors(){ document.querySelectorAll('.err-msg').forEach(n=>n.remove()); document.querySelectorAll('[aria-invalid="true"]').forEach(el=>el.setAttribute('aria-invalid','false')); }
    function setError(el, msg){ el.setAttribute('aria-invalid','true'); const d=document.createElement('div'); d.className='err-msg'; d.textContent=msg; el.insertAdjacentElement('afterend', d); }

    document.getElementById('ideaForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); clearErrors(); await resumeAudio();

      const ageEl=document.getElementById('age');
      const nicknameEl=document.getElementById('nickname');
      const problemEl=document.getElementById('problem');
      const ideaNameEl=document.getElementById('ideaName');
      const ideaDetailEl=document.getElementById('ideaDetail');
      const consent = document.getElementById('emailConsent').checked;
      const emailVal= document.getElementById('parentEmail').value.trim();

      let firstErr=null;
      if(!ageEl.value){ setError(ageEl,'ë‚˜ì´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); firstErr??=ageEl; }
      if(!nicknameEl.value.trim()){ setError(nicknameEl,'ë³„ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); firstErr??=nicknameEl; }
      if(problemEl.value.trim().length<5){ setError(problemEl,'ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); firstErr??=problemEl; }
      if(!ideaNameEl.value.trim()){ setError(ideaNameEl,'ë°œëª…í’ˆ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); firstErr??=ideaNameEl; }
      if(ideaDetailEl.value.trim().length<10){ setError(ideaDetailEl,'ì„¤ëª…ì€ 10ì ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); firstErr??=ideaDetailEl; }
      if(consent){ const emailOk=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(emailVal); if(!emailOk){ const el=document.getElementById('parentEmail'); setError(el,'ì´ë©”ì¼ í˜•ì‹ì´ ë§ì§€ ì•Šì•„ìš”. ì˜ˆ: parent@example.com'); firstErr??=el; } }
      if(firstErr){ firstErr.focus(); return; }

      // í™”ë©´ ì „í™˜
      document.getElementById('formScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.add('active');
      updateScreenFlag();

      // ë°ì´í„° ë°”ì¸ë”©
      document.getElementById('inventorName').textContent=nicknameEl.value.trim();
      document.getElementById('ideaDisplay').textContent=ideaNameEl.value.trim();
      const dimo=document.getElementById('dimoImg'); dimo.src=dimoImages[Math.floor(Math.random()*dimoImages.length)]; dimo.style.display='block';

      // ì ìˆ˜
      const len=ideaDetailEl.value.trim().length; let didPerfect=false;
      const scores = (len>=40 && Math.random()<0.04) ? (didPerfect=true,{creativity:5,feasibility:5,technical:5})
        : {creativity:Math.round((3.5+Math.random()*1.5)*2)/2, feasibility:Math.round((3.5+Math.random()*1.5)*2)/2, technical:Math.round((3.5+Math.random()*1.5)*2)/2};

      await animateStarsToScore('creativity',scores.creativity,'ë°˜ì§ì´ëŠ” ìƒìƒë ¥');
      await animateStarsToScore('feasibility',scores.feasibility,'ì •ë§ ë ê¹Œ? ì ìˆ˜');
      await animateStarsToScore('technical',scores.technical,'ë””ëª¨ì˜ ê¸°ìˆ ë ¥ ë ˆë²¨');
      setComplimentText();

      // ìŠ¤íƒ¬í”„ ì¢…ë¥˜
      let stampSrc=null;
      if(len>=30) stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„01.png';
      if(didPerfect){ stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„ë§Œì 02.png'; }
      else{ let rareP=(len>=70)?0.06:(len>=50)?0.03:0; if(Math.random()<rareP) stampSrc='ë””ëª¨ìŠ¤íƒ¬í”„ë ˆì–´03.png'; }

      if(len>=70){ showToastMsg('ğŸ¯ ë ˆì–´ í™•ë¥  2ë°° ê°•í™”!'); }

      // ìŠ¤íƒ¬í”„ ì¶”ê°€ + **ì¦‰ì‹œ ë°°ì¹˜(place) + ì´ë¯¸ì§€ ë¡œë“œ í›„ ì¬ë°°ì¹˜**
      setTimeout(async ()=>{
        if(stampSrc){
          const card=document.getElementById('card');
          const stampArea=document.getElementById('stampArea');
          const dimoImg=document.getElementById('dimoImg');

          const motionOK = !REDUCED;
          const rot = (Math.random()*2 - 1).toFixed(1);
          const cls = 'stamp-img' + (motionOK ? ' stamp-enter' : '');

          stampArea.innerHTML = `
            <div class="stamp-wrap" style="left:0;top:0;width:0;height:0;">
              <span class="stamp-puff" ${REDUCED?'style="display:none"':''}></span>
              <img src="${addVer(stampSrc)}" alt="ìŠ¤íƒ¬í”„" class="${cls}" style="--r:${rot}deg">
              <span class="ink-bleed" aria-hidden="true"></span>
            </div>`;

          function place(){
            try{
              const cardRect = card.getBoundingClientRect();
              const imgRect  = dimoImg.getBoundingClientRect();
              if(imgRect.width===0||imgRect.height===0) return;
              const wrap = stampArea.querySelector('.stamp-wrap'); if(!wrap) return;
              const pad=4;
              const size=Math.round(Math.min(132*0.8*1.1*1.10, imgRect.width*0.75, imgRect.height*0.75));
              const x = Math.round((imgRect.left - cardRect.left) + imgRect.width  - size - pad);
              const y = Math.round((imgRect.top  - cardRect.top)  + imgRect.height - size - pad);
              wrap.style.left = x+'px'; wrap.style.top = y+'px';
              wrap.style.width = size+'px'; wrap.style.height = size+'px';
              wrap.style.transformOrigin='100% 100%';
            }catch(e){}
          }

          // âœ… ì¦‰ì‹œ 1íšŒ
          place();
          // âœ… ì´ë¯¸ì§€ ë””ì½”ë“œ/ë¡œë“œ í›„ì—ë„ ë³´ì •
          if (dimoImg.decode){ dimoImg.decode().then(place).catch(()=>{}); }
          if (!dimoImg.complete){ dimoImg.addEventListener('load', place, {once:true}); }
          // âœ… ë·°í¬íŠ¸/ë¦¬ì‚¬ì´ì¦ˆì—ë„ ìœ ì§€
          addEventListener('resize', place, {passive:true});
          if (window.visualViewport) visualViewport.addEventListener('resize', place);
          if(navigator.vibrate && motionOK){ try{ navigator.vibrate(30);}catch{} }
        }
        fireConfetti(1800);
        playComplimentWithFallback();

        const card = document.getElementById('card');
        if(card && !REDUCED){ card.classList.add('finish-pulse'); setTimeout(()=>card.classList.remove('finish-pulse'), 900); }
      }, 600);
    });

    function setComplimentText(){
      const el = document.getElementById('complimentText'); if(!el) return;
      const lines = ["ğŸ¤© ì™€ìš°! ì‹¤í–‰ë ¥ë„ ê¸°ëŒ€ë¼","ğŸ’¡ ì•„ì´ë””ì–´ê°€ í†¡! íŠ€ì—ˆì–´","ğŸ‘ ë¬¸ì œì •ì˜ê°€ ê¹”ë”í–ˆì–´","ğŸš€ ìƒìƒë ¥ ë ˆë²¨ì—…! ë‹¤ìŒë„ ê°€ì","ğŸ”§ ì´ê±´ ì§„ì§œ ì¨ë³´ê³  ì‹¶ë‹¤","ğŸ§  ì²œì¬ì˜ ëƒ„ìƒˆê°€â€¦!"];
      el.textContent = 'ğŸ’¬ ' + lines[Math.floor(Math.random()*lines.length)];
    }

    function showToastMsg(msg){
      const t=document.getElementById('toast'); if(!t) return;
      if(String(msg).includes('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')) msg = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
      t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2800);
    }

    /* ì €ì¥ */
    (function(){
      const btn=document.getElementById('saveBtn'), toast=document.getElementById('toast');
      function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2800); }
      btn.addEventListener('click', async ()=>{
        await ensureScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
        const card=document.getElementById('card');
        const scale=Math.min(MOBILE?1.2:1.5, window.devicePixelRatio||1);
        html2canvas(card,{scale, useCORS:true}).then(canvas=>{
          const link=document.createElement('a');
          link.href=canvas.toDataURL('image/png'); link.download='dimo_card.png';
          if(/iPad|iPhone|iPod/.test(navigator.userAgent)){ const w=window.open(); if(w&&w.document) w.document.write('<img src="'+link.href+'" style="width:100%">'); }
          else link.click();
          showToastMsg('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }).catch(showToast);
      }, {passive:true});
    })();

    /* í™”ë©´ í”Œë˜ê·¸ */
    function updateScreenFlag(){
      const introActive  = document.getElementById('intro')?.classList.contains('active');
      const formActive   = document.getElementById('formScreen')?.classList.contains('active');
      const resultActive = document.getElementById('resultScreen')?.classList.contains('active');
      const screen = introActive ? 'intro' : (formActive ? 'form' : (resultActive ? 'result' : ''));
      document.body.dataset.screen = screen;
    }
    updateScreenFlag();
    new MutationObserver(updateScreenFlag).observe(document.body, {subtree:true, attributes:true, attributeFilter:['class']});

    /* ìŠ¤íŒŒí´ + íŒ¨ëŸ´ë™ìŠ¤ (reduce ê°€ë“œ) */
    (function(){
      const intro = document.getElementById('intro'); const layer = document.getElementById('fxLayer');
      if(!intro || !layer) return;
      function sparkBurst(x,y){
        if(REDUCED) return;
        const N=12;
        for(let i=0;i<N;i++){
          const el=document.createElement('span'); el.className='spark'; el.textContent=(i%3===0)?'âœ¦':(i%4===0?'â˜…':'âœ§');
          const ang=Math.random()*Math.PI*2, r=52+Math.random()*68, tx=(Math.cos(ang)*r).toFixed(1)+'px', ty=(Math.sin(ang)*r)+'px';
          el.style.left=x+'px'; el.style.top=y+'px'; el.style.setProperty('--tx',tx); el.style.setProperty('--ty',ty); el.style.color=`hsl(${200+Math.random()*140},85%,60%)`;
          layer.appendChild(el); el.addEventListener('animationend', ()=> el.remove(), {once:true});
        }
      }
      intro.addEventListener('pointerdown', (e)=> sparkBurst(e.clientX,e.clientY), {passive:true});

      if(!REDUCED){
        const targets=[intro.querySelector('.intro-main'),intro.querySelector('video'),intro.querySelector('#toForm')].filter(Boolean);
        targets.forEach(el=> el.style.willChange='transform');
        function tilt(e){
          const rect=intro.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
          const nx=(e.clientX-cx)/rect.width, ny=(e.clientY-cy)/rect.height;
          const MAX_DEG=6, MAX_MOVE=6, rx=-ny*MAX_DEG, ry=nx*MAX_DEG, tx=nx*MAX_MOVE, ty=ny*MAX_MOVE;
          for(const el of targets){ el.style.transform=`translate3d(${tx}px,${ty}px,0) rotateX(${rx}deg) rotateY(${ry}deg)`; }
        }
        function reset(){ for(const el of targets){ el.style.transform='translate3d(0,0,0) rotateX(0) rotateY(0)'; } }
        intro.addEventListener('pointermove', tilt, {passive:true});
        intro.addEventListener('pointerleave', reset, {passive:true});
      }
    })();

    /* ë°°ë„ˆ í…ìŠ¤íŠ¸/ë‚ ì§œ/ìŠ¤íƒ¬í”„ íš¨ê³¼ìŒ */
    (function(){
      const $=(s,r=document)=>r.querySelector(s); const BODY=document.body;
      function enhance(){ const b=$('#resultScreen .banner'); if(b && !b.dataset.v8){ b.dataset.v8='1'; b.textContent='ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì¹´ë“œ'; const fs=parseFloat(getComputedStyle(b).fontSize||'24'); b.style.fontSize=(fs*1.2)+'px'; } }
      const mo1=new MutationObserver(()=>{ if(BODY.dataset.screen==='result') enhance(); }); mo1.observe(BODY,{attributes:true, attributeFilter:['data-screen']}); if(BODY.dataset.screen==='result') enhance();

      function fmt(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
      function ensure(){ const card=$('#card'); if(!card) return; let el=$('#cardDate', card); if(!el){ el=document.createElement('div'); el.id='cardDate'; card.appendChild(el); } el.style.cssText='position:absolute;right:10px;bottom:2px;font-size:12px;opacity:.9;letter-spacing:.2px;'; el.textContent=fmt(new Date()); }
      const mo2=new MutationObserver(()=>{ if(BODY.dataset.screen==='result') ensure(); }); mo2.observe(BODY,{attributes:true, attributeFilter:['data-screen']}); if(BODY.dataset.screen==='result') ensure();

      (function stampSFX(){
        const area = $('#stampArea'); if(!area) return;
        let stampAC=null;
        function ensureAudio(id, src){ let a=document.getElementById(id); if(!a){ a=document.createElement('audio'); a.id=id; a.preload='none'; document.body.appendChild(a); } a.src=addVer(src); return a; }
        const aPerfect = ensureAudio('stampPerfect','ë§Œì ìš©ì¹­ì°¬.mp3');
        const aRare    = ensureAudio('í–‰ìš´ì˜ë ˆì–´í…œì¹­ì°¬','í–‰ìš´ì˜ë ˆì–´í…œì¹­ì°¬.mp3');
        async function play(a){
          try{ if(a.preload==='none') a.load(); if(!stampAC){ const C=window.AudioContext||window.webkitAudioContext; if(C) stampAC=new C(); } if(stampAC && stampAC.state==='suspended') await stampAC.resume(); a.currentTime=0; a.muted=false; a.volume=Math.min(a.volume||1,1); await a.play(); }
          catch(e){ const rs=$('#resultScreen'); const handler=async()=>{ rs.removeEventListener('pointerdown',handler); try{ await a.play(); }catch(_){} }; rs && rs.addEventListener('pointerdown',handler,{once:true}); }
        }
        const mo = new MutationObserver(muts=>{
          muts.forEach(m=>{
            m.addedNodes && m.addedNodes.forEach(n=>{
              if(n.nodeType!==1) return;
              const img = n.matches?.('img.stamp-img') ? n : n.querySelector?.('img.stamp-img');
              if(img && img.src){ if(/ë§Œì 02/i.test(img.src)) play(aPerfect); else if(/ë ˆì–´03/i.test(img.src)) play(aRare); }
            });
          });
        });
        mo.observe(area,{childList:true,subtree:true});
      })();
    })();
  </script>
</body>
</html>
