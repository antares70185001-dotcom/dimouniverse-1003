<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>디모와 함께 하는 상상 놀이터</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 폰트 -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

  <style>
    :root{
      --main:#5cab6d; --accent:#a5e6b8; --bg:#f8fff9; --text:#173322;
      --shadow:0 12px 40px rgba(0,0,0,.16);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Jua',sans-serif;background:var(--bg);color:var(--text)}
    .screen{display:none}.screen.active{display:block}

    /* 움직이는 파스텔 배경 */
    .pattern{
      position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.7;
      background:
        radial-gradient(circle at 12% 15%, rgba(165,230,184,.25) 0 140px, transparent 150px),
        radial-gradient(circle at 88% 25%, rgba(169,214,255,.22) 0 120px, transparent 130px),
        radial-gradient(circle at 18% 85%, rgba(255,214,232,.22) 0 140px, transparent 150px),
        radial-gradient(circle at 80% 82%, rgba(255,234,167,.20) 0 130px, transparent 140px);
      animation:dimo-bg-move 28s linear infinite;
    }
    @keyframes dimo-bg-move{
      0%{background-position:0 0,0 0,0 0,0 0}
      100%{background-position:600px 360px,-520px 480px,300px -420px,-300px 300px}
    }

    /* 버튼 */
    .btn{
      border:none;border-radius:28px;padding:14px 28px;font-size:18px;font-weight:800;
      cursor:pointer;white-space:nowrap;min-width:220px;position:relative;z-index:10;
    }
    .btn-primary{background:linear-gradient(90deg,#7bd49a,#4aa06b);color:#fff;box-shadow:0 8px 18px rgba(0,0,0,.12)}
    .btn-primary:hover{filter:brightness(1.05);transform:translateY(-1px)}

    /* 인트로 */
    .intro{
      min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:10px;padding:20px;text-align:center;background:linear-gradient(180deg,#f8fff9 0%, #e9fdee 100%);
      position:relative;
    }
    .intro-top{
      margin:0;color:#2c7a4c;font-size:36px;opacity:.9; /* 2배 확대 */
      animation:leftRight 7s ease-in-out infinite;
    }
    @keyframes leftRight{0%,100%{transform:translateX(-6px)}50%{transform:translateX(6px)}}
    .intro-main{
      margin:0;font-size:60px;line-height:1.1; /* 46px → 60px (≈30% ↑) */
      background:linear-gradient(90deg,#A5E6B8,#A9D6FF,#FFD6E8,#FFEAA7,#A5E6B8);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:300% 100%;
      animation:shine 6s linear infinite; text-shadow:0 4px 10px rgba(0,0,0,.08);
    }
    @keyframes shine{0%{background-position:0%}100%{background-position:100%}}
    video{width:780px;max-width:100%;border-radius:18px;box-shadow:var(--shadow)}

    /* 공용 하단 로고(텍스트) */
    .footer-logo{
      position:absolute;left:50%;transform:translateX(-50%);bottom:12px;
      font-size:20px; /* 더 크게 */
      color:#0b2a6f;  /* 남색 */
      letter-spacing:1px;
    }
    .intro-footer{ bottom:18px; } /* 인트로에서 약간 위로 */

    @media (max-width:480px){
      .intro-main{font-size:50px}
      .intro-top{font-size:32px}
    }

    /* 폼 */
    .wrap{max-width:740px;margin:0 auto;padding:16px}
    form{background:#fff;border:3px solid var(--accent);border-radius:20px;padding:22px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .form-group{margin-bottom:18px}
    label{display:block;margin-bottom:8px;color:#1e3e2d;font-weight:900}
    input,select,textarea{
      width:100%;font-family:'Jua',sans-serif;font-size:16px;border:2px solid #d3f2db;border-radius:12px;padding:12px;background:#fff;
      transition:border .15s, box-shadow .15s
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--main);box-shadow:0 0 0 3px rgba(92,171,109,.18)}
    textarea{min-height:110px;resize:vertical}

    /* 디모 스타일 게이지 */
    .gauge{margin-top:8px;background:#eef6ef;border-radius:12px;height:18px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,.06)}
    .gauge-bar{height:100%;width:0%;background:#b7e3c7;transition:width .35s ease, background .35s ease;position:relative}
    .gauge-gloss{content:"";position:absolute;inset:0;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,.55),rgba(255,255,255,0));mix-blend-mode:screen}
    .sparkle{position:absolute;top:50%;transform:translateY(-50%);width:26px;height:26px;border-radius:50%;
      background:radial-gradient(circle,#fff 0 25%,rgba(255,255,255,.0) 60%);opacity:.0;animation:spark 2.4s ease-in-out infinite}
    .sparkle.r{right:6px}.sparkle.l{left:6px;animation-delay:1.2s}
    @keyframes spark{0%,100%{opacity:.0;transform:translateY(-50%) scale(.6)}50%{opacity:.65;transform:translateY(-50%) scale(1)}}
    .gmsg{margin-top:8px;font-size:16px;color:#2d4d38;min-height:1.6em}

    /* 결과 카드 */
    .card{position:relative;background:#fff;border:3px solid var(--accent);border-radius:20px;padding:20px 20px 64px;
      max-width:740px;margin:0 auto;box-shadow:0 10px 22px rgba(0,0,0,.12);overflow:hidden}
    .banner{margin:0 0 12px;text-align:center;color:#2d4d38;font-size:26px}
    .card-body{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:flex-start}
    .dimo{width:clamp(108px,26vw,160px);border-radius:16px;display:none}
    .ratings{display:grid;gap:10px}
    .rating{display:flex;flex-direction:column;gap:6px;background:#f9fffb;border:2px solid #d3f2db;border-radius:10px;padding:10px 12px}
    .rating h3{margin:0;font-size:16px;color:#2d4d38;order:0}   /* 제목 위 */
    .rating .stars{order:1;margin-top:4px}                     /* 별점 아래 */

    /* 별점(회차 애니) */
    .stars{display:flex;gap:6px;white-space:nowrap;font-size:24px}
    .star{position:relative;color:#d8d8d8}
    .star.full{color:#ffcc00;text-shadow:1px 1px 6px rgba(255,204,0,.7)}
    .star.half::before{content:"★";position:absolute;left:0;top:0;width:50%;overflow:hidden;color:#ffcc00;text-shadow:1px 1px 6px rgba(255,204,0,.7)}
    .star.pop{animation:starPop .42s ease-out}
    @keyframes starPop{
      0%{transform:scale(.6) rotate(-8deg);filter:drop-shadow(0 0 0 rgba(255,204,0,0))}
      60%{transform:scale(1.25) rotate(0);filter:drop-shadow(0 0 10px rgba(255,204,0,.7))}
      100%{transform:scale(1)}
    }
    .stars.twinkle .star.full, .stars.twinkle .star.half{animation:twinkle 700ms ease}
    @keyframes twinkle{0%{transform:scale(1)}100%{transform:scale(1.12)}}

    /* 발명자/발명품: 세로 정렬 */
    .info{
      margin-top:10px;padding:10px 12px;border-radius:12px;border:2px solid #d3f2db;background:#fafffa;
      text-align:center;font-size:16px;display:flex;flex-direction:column;gap:6px;align-items:center
    }
    .info strong{color:var(--main)}

    /* 스탬프 */
    #stampArea{position:absolute;inset:0;pointer-events:none}
    .stamp-wrap{position:absolute}
    .stamp-img{width:100%;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.1))}
    .stamp-enter{animation:pop .52s cubic-bezier(.18,1.4,.22,1) forwards}
    @keyframes pop{
      0%{opacity:0;transform:translateY(-14px) scale(1.3) rotate(var(--r,-4deg))}
      65%{opacity:1;transform:translateY(0) scale(.98) rotate(var(--r,-4deg))}
      100%{transform:scale(1) rotate(var(--r,-4deg))}
    }

    /* 저장 */
    .center{text-align:center;margin-top:14px}
    .btn-save{background:linear-gradient(135deg,#bff3c8,#8de0d3);color:#0f3a30;font-weight:900;min-width:320px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#2c7a4c;color:#fff;padding:12px 16px;border-radius:10px;
      font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.18);opacity:0;visibility:hidden;transition:.25s;z-index:9999}
    .toast.show{opacity:1;visibility:visible}

    @media (max-width:480px){
      .card-body{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="pattern" aria-hidden="true"></div>

  <!-- 인트로 -->
  <section id="intro" class="screen active">
    <div class="intro">
      <h2 class="intro-top">디모와 함께 하는</h2>
      <h1 class="intro-main">상상 놀이터</h1>

      <video autoplay muted loop playsinline webkit-playsinline>
        <source src="dimo.mp4" type="video/mp4">
      </video>

      <button id="toForm" class="btn btn-primary">▶ 디모 만나러 가기</button>

      <!-- 하단 중앙 텍스트 로고 -->
      <div class="footer-logo intro-footer">DIMO UNIVERSE</div>

      <!-- 인사 음성 (랜덤 1개) -->
      <audio id="intro1" src="디모인트로인사1.mp3" preload="auto"></audio>
      <audio id="intro2" src="디모인트로인사2.mp3" preload="auto"></audio>
      <audio id="intro3" src="디모인트로인사3.mp3" preload="auto"></audio>
      <audio id="intro4" src="디모인트로인사4.mp3" preload="auto"></audio>
    </div>
  </section>

  <!-- 설문 -->
  <section id="formScreen" class="screen">
    <div class="wrap">
      <form id="ideaForm" novalidate>
        <div class="form-group">
          <label>1. 디모는 친구 나이가 궁금해! *</label>
          <select id="age" required>
            <option value="">선택하세요</option>
            <option value="8">8세</option><option value="9">9세</option><option value="10">10세</option>
            <option value="11">11세</option><option value="12">12세</option><option value="13">13세</option>
            <option value="14">14세</option><option value="15">15세</option><option value="16">16세</option>
            <option value="17">17세</option><option value="18">18세</option><option value="19">19세</option>
          </select>
        </div>

        <div class="form-group">
          <label>2. 너의 멋진 별명을 정해줘! *</label>
          <input id="nickname" type="text" placeholder="예: 발명왕 디모!" required>
        </div>

        <div class="form-group">
          <label>3. '아~ 이거 불편하다!' 했던 순간은? *</label>
          <textarea id="problem" placeholder="예: 연필이 자꾸 굴러가서 잃어버려요" required></textarea>
        </div>

        <div class="form-group">
          <label>4. 그 불편을 해결할 멋진 발명품 이름은? *</label>
          <input id="ideaName" type="text" placeholder="예: 안 굴러가는 연필" required>
        </div>

        <div class="form-group">
          <label>5. 발명품은 어떻게 작동하고 뭐가 편해져? *</label>
          <textarea id="ideaDetail" placeholder="예: 연필에 작은 자석이 붙어서 책상에 딱 붙어요…" required></textarea>

          <!-- 디모 스타일 게이지 -->
          <div class="gauge" aria-hidden="true">
            <div class="gauge-bar" id="charBar"></div>
            <div class="gauge-gloss"></div>
            <div class="sparkle l"></div>
            <div class="sparkle r"></div>
          </div>
          <div id="charMsg" class="gmsg">🌱 아직 생각의 씨앗이에요</div>
          <!-- 안내 문구(퍼센트/확률) 라인은 요청에 따라 제거 -->
        </div>

        <!-- 이메일 안내 및 선택 입력 -->
        <div class="form-group">
          <label>6. (선택) 보호자 이메일</label>
          <div style="font-size:14px;color:#2d4d38;opacity:.9;margin:6px 0 10px">
            ※ <b>굿즈 이벤트 응모를 원할 경우에만</b> 이메일을 입력해요. <b>입력하지 않아도 스탬프는 그대로 진행</b>돼요.
          </div>

          <label style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
            <input id="emailConsent" type="checkbox">
            굿즈 이벤트 응모 (선택) — 이메일 입력
          </label>

          <div id="emailBlock" style="display:none">
            <input id="parentEmail" type="email" placeholder="예: parent@example.com" inputmode="email">
            <div style="font-size:14px;color:#2d4d38;opacity:.8;margin-top:6px">
              ※ 이메일은 <b>경품(굿즈) 당첨 안내</b> 용도로만 사용되며, 행사 종료 후 즉시 파기됩니다.
            </div>
          </div>
        </div>

        <!-- 힌트 음성 (첫 클릭 1회) -->
        <audio id="hintNickname"   src="별명안내멘트.mp3" preload="auto"></audio>
        <audio id="hintProblem"    src="불편한점안내멘트.mp3" preload="auto"></audio>
        <audio id="hintIdeaDetail" src="아이디어설명멘트.mp3" preload="auto"></audio>

        <div class="center"><button type="submit" class="btn btn-primary">제출하기</button></div>
      </form>
    </div>
  </section>

  <!-- 결과 -->
  <section id="resultScreen" class="screen">
    <div class="wrap">
      <div id="card" class="card">
        <h2 class="banner">나만의 아이디어 카드</h2>
        <div class="card-body">
          <img id="dimoImg" class="dimo" alt="디모" src="">
          <div class="ratings">
            <div class="rating"><h3>반짝이는 상상력</h3><div id="creativity" class="stars"></div></div>
            <div class="rating"><h3>정말 될까? 점수</h3><div id="feasibility" class="stars"></div></div>
            <div class="rating"><h3>디모의 기술력 레벨</h3><div id="technical" class="stars"></div></div>
          </div>
        </div>

        <div class="info">
          <span>👤 <strong>발명자:</strong> <span id="inventorName"></span></span>
          <span>💡 <strong>내 발명품:</strong> <span id="ideaDisplay"></span></span>
        </div>

        <div id="stampArea"></div>
        <div class="footer-logo">DIMO UNIVERSE</div>

        <!-- 결과 화면 칭찬 음성 (랜덤 재생용) -->
        <audio id="compliment1" src="디모칭찬01.mp3" preload="auto"></audio>
        <audio id="compliment2" src="디모칭찬02.mp3" preload="auto"></audio>
        <audio id="compliment3" src="디모칭찬03.mp3" preload="auto"></audio>
        <audio id="compliment4" src="디모칭찬04.mp3" preload="auto"></audio>
        <audio id="compliment5" src="디모칭찬05.mp3" preload="auto"></audio>
        <audio id="compliment6" src="디모 칭찬 메시지.mp3" preload="auto"></audio>
      </div>

      <div class="center"><button id="saveBtn" class="btn btn-save">🎨 카드 저장하기</button></div>
    </div>
  </section>

  <div id="toast" class="toast">📥 앨범에 저장되었어요!</div>

  <!-- 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const MOBILE = matchMedia('(max-width: 480px), (pointer: coarse)').matches;
    const dimoImages = ["dimo01.png","dimo02.png","dimo03.png","dimo04.png"];
    const STAR_STEP_MS = 260;

    /* ===== 오디오 컨텍스트: 클릭 시 깨우기 ===== */
    let AC=null;
    async function resumeAudio(){
      try{
        const C = window.AudioContext || window.webkitAudioContext;
        if(!AC && C) AC = new C();
        if(AC && AC.state === 'suspended') await AC.resume();
      }catch(e){}
    }

    /* 단일 오디오 안전 재생 */
    async function playOne(a){
      if(!a) return false;
      try{
        await resumeAudio();
        a.currentTime=0; a.muted=false; a.volume=Math.min(a.volume||1,1);
        await a.play();
        return true;
      }catch(e){ return false; }
    }

    /* 콘페티 */
    function fireConfetti(duration=1500){
      const end = Date.now() + duration;
      (function frame(){
        if(window.confetti){
          confetti({particleCount: 6, startVelocity: 32, spread: 360, origin:{x:Math.random(), y:Math.random()*0.4}});
        }
        if(Date.now() < end) requestAnimationFrame(frame);
      })();
    }

    /* 별점 애니메이션 */
    function animateStarsToScore(id, score){
      return new Promise(resolve=>{
        const el=document.getElementById(id); if(!el) return resolve();
        el.innerHTML = '<span class="star">★</span>'.repeat(5);
        const full=Math.floor(score);
        const hasHalf = (score-full) >= 0.5;
        let idx=0, target=full + (hasHalf?1:0);
        (function step(){
          if(idx>=target){ setTimeout(resolve, 250); return; }
          const s=el.children[idx];
          if(idx<full){ s.classList.add('full','pop'); }
          else if(hasHalf){ s.classList.add('half','pop'); }
          idx++; setTimeout(step, STAR_STEP_MS);
        })();
      });
    }

    /* 결과 칭찬 오디오 랜덤 */
    function pickRandomCompliment(){
      const ids=["compliment1","compliment2","compliment3","compliment4","compliment5","compliment6"];
      const els=ids.map(id=>document.getElementById(id)).filter(Boolean);
      return els[Math.floor(Math.random()*els.length)];
    }
    async function playComplimentWithFallback(){
      const a = pickRandomCompliment(); if(!a) return;
      let ok = await playOne(a);
      if(!ok){
        const rs=document.getElementById('resultScreen');
        const handler = async ()=>{ rs.removeEventListener('pointerdown', handler); await playOne(a); };
        rs.addEventListener('pointerdown', handler, {once:true});
      }
    }

    /* ===== 인트로 → 폼: 음성 종료 후 2초 뒤 전환 ===== */
    (function(){
      const btn=document.getElementById('toForm');
      const intro=document.getElementById('intro');
      const form=document.getElementById('formScreen');
      const intros=["intro1","intro2","intro3","intro4"].map(id=>document.getElementById(id)).filter(Boolean);

      btn.addEventListener('click', async ()=>{
        await resumeAudio();
        const pick=a=>a[Math.floor(Math.random()*a.length)];
        const audio=intros.length?pick(intros):null;

        const go=()=>{
          intro.classList.remove('active');
          form.classList.add('active');
          document.getElementById('ideaDetail').focus();
        };

        if(audio){
          const started = await playOne(audio);
          if(started){
            audio.onended = ()=> setTimeout(go, 2000); // 재생 끝난 뒤 + 2초
          }else{
            setTimeout(go, 2000); // 재생 실패 시 2초 후
          }
        }else{
          setTimeout(go, 2000);   // 오디오 없으면 2초 후
        }
      }, {passive:true});
    })();

    /* 힌트 음성 (첫 클릭 1회) */
    (function(){
      const once={once:true,passive:true};
      document.getElementById('nickname').addEventListener('click',()=>playOne(document.getElementById('hintNickname')),once);
      document.getElementById('problem').addEventListener('click',()=>playOne(document.getElementById('hintProblem')),once);
      document.getElementById('ideaDetail').addEventListener('click',()=>playOne(document.getElementById('hintIdeaDetail')),once);
    })();

    /* 게이지 & 메시지 */
    (function(){
      const detail=document.getElementById('ideaDetail');
      const bar=document.getElementById('charBar');
      const msg=document.getElementById('charMsg');

      function update(){
        const len=(detail.value||'').trim().length;
        const pct=Math.min(len/70*100,100);
        bar.style.width=pct+'%';

        if(len<30){ bar.style.background='#ffcc00'; msg.textContent=''; } /* 회색→노란색, 글귀 제거 */
        else if(len<40){ bar.style.background='linear-gradient(90deg,#a8e6c3,#7bd49a)'; msg.textContent='🎉 디모 스탬프 획득!'; }
        else if(len<50){ bar.style.background='linear-gradient(90deg,#8ac7ff,#4f92ff)'; msg.textContent='💫 만점 가능성 도달!'; }
        else if(len<70){ bar.style.background='linear-gradient(90deg,#a48bff,#6a5acd)'; msg.textContent='💎 레어 스탬프 추첨권 획득!'; }
        else { bar.style.background='linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)'; msg.textContent='🌈 레어 스탬프 당첨 확률 2배 강화!'; }
      }
      detail.addEventListener('input',update,{passive:true}); update();
    })();

    /* 별 반짝임 클릭 */
    (function(){
      document.addEventListener('click',(e)=>{
        const stars = e.target.closest('.stars');
        if(!stars) return;
        stars.classList.add('twinkle');
        setTimeout(()=>stars.classList.remove('twinkle'),700);
      }, {passive:true});
    })();

    /* 이메일 선택 시 입력창/안내 표시 */
    (function(){
      const consent = document.getElementById('emailConsent');
      const block   = document.getElementById('emailBlock');
      const email   = document.getElementById('parentEmail');
      const toggle = ()=>{
        const on = !!consent.checked;
        block.style.display = on ? 'block' : 'none';
        if(!on){ email.value=''; }
      };
      consent.addEventListener('change', toggle, {passive:true});
      toggle();
    })();

    /* 제출 처리 */
    document.getElementById('ideaForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      await resumeAudio(); // 제출 제스처 시 오디오 권한 확보

      const age=document.getElementById('age').value;
      const nickname=document.getElementById('nickname').value.trim();
      const problem=document.getElementById('problem').value.trim();
      const ideaName=document.getElementById('ideaName').value.trim();
      const ideaDetail=document.getElementById('ideaDetail').value.trim();

      const consent = document.getElementById('emailConsent').checked;
      const emailVal= document.getElementById('parentEmail').value.trim();
      if(!age||!nickname||!problem||!ideaName||ideaDetail.length<10){
        alert('모든 항목을 채워줘! (설명은 10자 이상)'); return;
      }
      if(consent){
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(emailVal);
        if(!emailOk){ alert('이메일 형식이 맞지 않아! 예: parent@example.com'); return; }
      }

      // 결과 화면 전환
      document.getElementById('formScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.add('active');

      // 데이터 바인딩
      document.getElementById('inventorName').textContent=nickname;
      document.getElementById('ideaDisplay').textContent=ideaName;
      const dimo=document.getElementById('dimoImg');
      dimo.src=dimoImages[Math.floor(Math.random()*dimoImages.length)];
      dimo.style.display='block';

      // 점수 계산
      const len=ideaDetail.length;
      let didPerfect=false;
      const scores = (len>=40 && Math.random()<0.04)
        ? (didPerfect=true, {creativity:5,feasibility:5,technical:5})
        : {
            creativity: Math.round((3.5+Math.random()*1.5)*2)/2,
            feasibility: Math.round((3.5+Math.random()*1.5)*2)/2,
            technical: Math.round((3.5+Math.random()*1.5)*2)/2
          };

      // 별점 애니
      ['creativity','feasibility','technical'].forEach(id=>{
        const el=document.getElementById(id); el.innerHTML='';
      });
      await animateStarsToScore('creativity',  scores.creativity);
      await animateStarsToScore('feasibility', scores.feasibility);
      await animateStarsToScore('technical',   scores.technical);

      // 스탬프 판정
      let stampSrc=null;
      if(len>=30) stampSrc='디모스탬프01.png';
      if(didPerfect){ stampSrc='디모스탬프만점02.png'; }
      else{
        let rareP = (len>=70) ? 0.06 : (len>=50) ? 0.03 : 0;
        if(Math.random()<rareP) stampSrc='디모스탬프레어03.png';
      }

      // 70자↑ 토스트
      if(len>=70){ showToastMsg('🎯 레어 확률 2배 강화!'); }

      // 2초 뒤 스탬프 + 폭죽 + 칭찬
      setTimeout(async ()=>{
        if(stampSrc){
          const card=document.getElementById('card');
          const stampArea=document.getElementById('stampArea');
          const size=132, offset=18;
          const x=card.clientWidth - size - offset, y=offset;
          stampArea.innerHTML = `
            <div class="stamp-wrap" style="left:${x}px;top:${y}px;width:${size}px;height:${size}px;">
              <img src="${stampSrc}" alt="스탬프" class="stamp-img stamp-enter" style="--r:${(Math.random()*8-4).toFixed(1)}deg">
            </div>`;
          if(navigator.vibrate){ try{ navigator.vibrate(25);}catch{} }
        }
        fireConfetti(1800);
        playComplimentWithFallback();
      }, 2000);
    });

    function showToastMsg(msg){
      const t=document.getElementById('toast'); if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1600);
    }

    /* 저장 (스탬프 포함 캡처) */
    (function(){
      const btn=document.getElementById('saveBtn'), toast=document.getElementById('toast');
      function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1600); }
      btn.addEventListener('click', ()=>{
        const card=document.getElementById('card');
        const scale=Math.min(MOBILE?1.2:1.5, window.devicePixelRatio||1);
        html2canvas(card,{scale, useCORS:true}).then(canvas=>{
          const link=document.createElement('a');
          link.href=canvas.toDataURL('image/png'); link.download='dimo_card.png';
          if(/iPad|iPhone|iPod/.test(navigator.userAgent)){
            const w=window.open(); if(w&&w.document) w.document.write('<img src="'+link.href+'" style="width:100%">');
          } else link.click();
          showToast();
        }).catch(showToast);
      }, {passive:true});
    })();
  </script>
</body>
</html>
